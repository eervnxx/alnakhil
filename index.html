<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قاعة النخيل للمناسبات - نظام إدارة الحجوزات</title>
    
    <!-- إضافات PWA -->
    <link rel="manifest" href="/h/manifest.json">
    <meta name="theme-color" content="#2c5f2d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="قاعة النخيل">
    <link rel="apple-touch-icon" href="/h/icons/icon-192x192.png">
    <meta name="msapplication-TileImage" content="/h/icons/icon-144x144.png">
    <meta name="msapplication-TileColor" content="#2c5f2d">
    <meta name="application-name" content="قاعة النخيل">
    
    <!-- رابط الخطوط -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ==================== أنماط صفحة تسجيل الدخول ==================== */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px;
        }
        
        .login-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.8s ease;
        }
        
        .login-logo {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .login-title {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 1rem;
        }
        
        .login-form {
            margin-top: 30px;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            transition: all 0.3s;
            letter-spacing: 2px;
            font-family: monospace;
        }
        
        .login-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
            outline: none;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .login-instructions {
            margin-top: 25px;
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--dark);
            text-align: right;
        }
        
        .login-instructions h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .login-error {
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        /* ==================== إخفاء التطبيق الرئيسي قبل تسجيل الدخول ==================== */
        .main-app {
            display: none;
        }
        
        /* الأنماط الأصلية لموقعك تبقى كما هي */
        :root {
            --primary: #2c5f2d;
            --primary-light: #4a8c4a;
            --secondary: #d4af37;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --purple: #9c27b0;
            --light-green: #4caf50;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding-bottom: 50px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* ترويسة الموقع */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo i {
            font-size: 2.5rem;
            margin-left: 15px;
            color: var(--secondary);
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .logo p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .telegram-badge {
            background-color: #0088cc;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        /* التنقل بين الصفحات */
        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            min-width: 150px;
        }
        
        .nav-tab:hover {
            background-color: var(--gray-light);
        }
        
        .nav-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
        }
        
        /* محتوى الصفحات */
        .page {
            display: none;
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-title {
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
            display: flex;
            align-items: center;
        }
        
        .page-title i {
            margin-left: 10px;
            color: var(--secondary);
        }
        
        /* تصميم النماذج */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
            padding: 0 10px;
            margin-bottom: 20px;
        }
        
        .form-group.full-width {
            flex: 0 0 100%;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .required::after {
            content: " *";
            color: var(--danger);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
        }
        
        /* خدمة التصوير - التصميم البسيط */
        .photography-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .photography-options-simple {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .photography-option-simple {
            flex: 1;
        }
        
        .photography-option-simple input[type="radio"] {
            display: none;
        }
        
        .photography-option-simple label {
            display: block;
            padding: 12px 15px;
            background-color: white;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
            font-weight: 600;
        }
        
        .photography-option-simple input[type="radio"]:checked + label.add-photo {
            background-color: rgba(23, 162, 184, 0.1);
            border-color: var(--info);
            color: var(--info);
        }
        
        .photography-option-simple input[type="radio"]:checked + label.no-photo {
            background-color: rgba(108, 117, 125, 0.1);
            border-color: var(--gray);
            color: var(--gray);
        }
        
        /* أزرار اختيار القاعة */
        .hall-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .hall-option {
            flex: 1;
            min-width: 200px;
        }
        
        .hall-option input[type="checkbox"] {
            display: none;
        }
        
        .hall-option label {
            display: block;
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .hall-option input[type="checkbox"]:checked + label {
            background-color: rgba(44, 95, 45, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }
        
        .hall-badge {
            display: inline-block;
            padding: 3px 10px;
            background-color: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        /* حقل تحديد الكل */
        .select-all {
            margin-bottom: 15px;
        }
        
        /* أزرار المبلغ */
        .amount-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .amount-item {
            flex: 1;
            min-width: 200px;
        }
        
        .amount-item input {
            background-color: var(--gray-light);
        }
        
        /* أزرار الإجراءات */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background-color: #dde0e3;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-telegram {
            background-color: #0088cc;
            color: white;
        }
        
        .btn-telegram:hover {
            background-color: #0077b5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-phone {
            background-color: #9c27b0;
            color: white;
        }
        
        .btn-phone:hover {
            background-color: #7b1fa2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-camera {
            background-color: #9c27b0;
            color: white;
        }
        
        .btn-camera:hover {
            background-color: #7b1fa2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* صفحة المعاينة */
        .preview-container {
            background-color: white;
            border-radius: 10px;
            max-width: 1000px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .preview-header {
            text-align: center;
            padding: 20px;
            background-color: white;
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--secondary);
        }
        
        .preview-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .preview-header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .preview-logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .preview-content {
            display: flex;
            flex-wrap: wrap;
            padding: 0 20px 20px;
        }
        
        .preview-left {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            border-left: 1px solid #eee;
        }
        
        .preview-right {
            flex: 1;
            min-width: 300px;
            padding: 15px;
        }
        
        .detail-section {
            margin-bottom: 15px;
        }
        
        .detail-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1rem;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-content {
            font-size: 0.95rem;
        }
        
        .detail-row {
            margin-bottom: 6px;
            display: flex;
        }
        
        .detail-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .detail-value {
            flex: 1;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .hall-tag {
            display: inline-block;
            padding: 4px 10px;
            background-color: var(--primary);
            color: white;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 5px;
            font-size: 0.8rem;
        }
        
        .photography-tag {
            display: inline-block;
            padding: 4px 10px;
            background-color: var(--info);
            color: white;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 5px;
            font-size: 0.8rem;
        }
        
        .signature-area {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .signature-box {
            height: 60px;
            border: 1px dashed #999;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            background-color: white;
            font-size: 0.9rem;
        }
        
        .terms {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        
        .terms h4 {
            color: var(--primary);
            margin-bottom: 8px;
            text-align: center;
            font-size: 1rem;
        }
        
        .terms ul {
            padding-right: 15px;
        }
        
        .terms li {
            margin-bottom: 5px;
            line-height: 1.4;
            font-size: 0.85rem;
        }
        
        .notes-section {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        /* قائمة الحجوزات */
        .reservations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .reservations-table th, .reservations-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .reservations-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .reservations-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .hall-badge-list {
            display: inline-block;
            padding: 3px 6px;
            background-color: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 5px;
        }
        
        .photography-badge-list {
            display: inline-block;
            padding: 3px 6px;
            background-color: var(--info);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 5px;
        }
        
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        /* أزرار الإجراءات في الجدول */
        .action-cell {
            display: flex;
            gap: 6px;
            justify-content: flex-start;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }
        
        .action-btn.view {
            background-color: var(--info);
            color: white;
        }
        
        .action-btn.view:hover {
            background-color: #138496;
        }
        
        .action-btn.delete {
            background-color: var(--danger);
            color: white;
        }
        
        .action-btn.delete:hover {
            background-color: #c82333;
        }
        
        .action-btn.camera {
            background-color: #9c27b0;
            color: white;
        }
        
        .action-btn.camera:hover {
            background-color: #7b1fa2;
        }
        
        /* رسائل التنبيه */
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: rgba(40, 167, 69, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .alert-error {
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .alert-info {
            background-color: rgba(23, 162, 184, 0.1);
            border: 1px solid var(--info);
            color: var(--info);
        }
        
        /* تحسينات للطباعة */
        .print-optimized {
            font-size: 13px;
            line-height: 1.3;
        }
        
        .amount-display {
            background-color: #f0f8f0;
            padding: 10px;
            border-radius: 6px;
            border-right: 3px solid var(--primary);
        }
        
        .amount-display .detail-row {
            margin-bottom: 5px;
        }
        
        /* تيلجرام ستاتس */
        .telegram-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .telegram-sent {
            background-color: rgba(0, 136, 204, 0.1);
            color: #0088cc;
            border: 1px solid rgba(0, 136, 204, 0.2);
        }
        
        .telegram-failed {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .telegram-pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        /* ==================== صفحة تقويم الحجوزات ==================== */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .calendar-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-title {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .month-year {
            font-size: 1.2rem;
            color: var(--dark);
            font-weight: 600;
        }
        
        .calendar-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--primary);
            color: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .calendar-header-cell {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }
        
        .calendar-header-cell:first-child {
            border-left: none;
        }
        
        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #eee;
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }
        
        .calendar-day {
            min-height: 90px;
            padding: 8px;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            position: relative;
            transition: all 0.3s;
        }
        
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        
        .calendar-day.empty {
            background-color: #f9f9f9;
        }
        
        .calendar-day.today {
            background-color: rgba(44, 95, 45, 0.1);
            border: 2px solid var(--primary);
        }
        
        .day-number {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 6px;
        }
        
        .reservations-list {
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        
        .reservation-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reservation-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .hall1-badge {
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
        }
        
        .hall2-badge {
            background-color: rgba(0, 123, 255, 0.9);
            color: white;
        }
        
        .both-halls-badge {
            background-color: rgba(255, 193, 7, 0.9);
            color: #333;
        }
        
        /* الإضافات الجديدة للأرقام 1x و 2x */
        .hall1-second-badge {
            background-color: rgba(156, 39, 176, 0.9);
            color: white;
        }
        
        .hall2-second-badge {
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
        }
        
        .calendar-legends {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
        
        /* ==================== صفحة عرسان اليوم ==================== */
        .brides-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .bride-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            border-top: 4px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        .bride-card:hover {
            transform: translateY(-5px);
        }
        
        /* ألوان الإطارات */
        .bride-card.hall1 {
            border-top-color: #dc3545; /* أحمر - القاعة 1 */
        }
        
        .bride-card.hall1x {
            border-top-color: #9c27b0; /* بنفسجي - القاعة 1x */
        }
        
        .bride-card.hall2 {
            border-top-color: #007bff; /* أزرق - القاعة 2 */
        }
        
        .bride-card.hall2x {
            border-top-color: #4caf50; /* أخضر - القاعة 2x */
        }
        
        .bride-card.both-halls {
            border-top-color: #ffc107; /* ذهبي - القاعتين معاً */
        }
        
        .hall-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark);
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .bride-details-simple {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .bride-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .bride-row:last-child {
            border-bottom: none;
        }
        
        .bride-label {
            font-weight: bold;
            min-width: 100px;
            color: var(--primary);
            font-size: 0.95rem;
        }
        
        .bride-value {
            flex: 1;
            color: var(--dark);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--gray-light);
        }
        
        .empty-state h3 {
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        /* شريط تحكم تاريخ عرسان اليوم */
        .brides-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-selector input {
            width: 200px;
        }
        
        .brides-count {
            margin-right: auto;
            font-weight: bold;
            color: var(--primary);
            background: rgba(44, 95, 45, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        /* تصميم متجاوب */
        @media (max-width: 1200px) {
            .container {
                max-width: 95%;
            }
        }
        
        @media (max-width: 992px) {
            .calendar-day {
                min-height: 80px;
                padding: 6px;
            }
            
            .day-number {
                font-size: 0.9rem;
            }
            
            .reservation-badge {
                font-size: 0.65rem;
                padding: 2px 5px;
            }
            
            .brides-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                margin-bottom: 15px;
            }
            
            .nav-tab {
                flex: 1 0 50%;
            }
            
            .form-group {
                flex: 0 0 100%;
            }
            
            .hall-option {
                flex: 0 0 100%;
            }
            
            .photography-option-simple {
                flex: 0 0 100%;
            }
            
            .amount-item {
                flex: 0 0 100%;
            }
            
            .preview-content {
                flex-direction: column;
            }
            
            .preview-left {
                border-left: none;
                border-top: 1px solid #eee;
            }
            
            .reservations-table {
                display: block;
                overflow-x: auto;
            }
            
            .action-cell {
                flex-direction: column;
                gap: 4px;
            }
            
            .calendar-header-cell {
                padding: 8px 4px;
                font-size: 0.85rem;
            }
            
            .calendar-day {
                min-height: 70px;
                padding: 4px;
            }
            
            .day-number {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }
            
            .calendar-controls {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .calendar-navigation {
                width: 100%;
                justify-content: center;
            }
            
            /* تسجيل الدخول على الهواتف */
            .login-container {
                padding: 25px;
                margin: 20px;
            }
            
            .login-logo {
                font-size: 3rem;
            }
            
            .login-title {
                font-size: 1.6rem;
            }
            
            /* صفحة عرسان اليوم على الهواتف */
            .brides-grid {
                grid-template-columns: 1fr;
            }
            
            .brides-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-selector {
                width: 100%;
            }
            
            .date-selector input {
                width: 100%;
            }
            
            .brides-count {
                margin-right: 0;
                text-align: center;
                margin-top: 10px;
            }
        }
        
        @media (max-width: 576px) {
            .calendar-header-cell {
                font-size: 0.8rem;
                padding: 6px 3px;
            }
            
            .calendar-day {
                min-height: 60px;
            }
            
            .reservation-badge {
                font-size: 0.6rem;
                padding: 2px 3px;
            }
            
            .legend-item {
                font-size: 0.75rem;
            }
            
            .calendar-legends {
                gap: 8px;
            }
            
            .photography-options-simple {
                flex-direction: column;
            }
            
            /* تسجيل الدخول على الهواتف الصغيرة */
            .login-container {
                padding: 20px;
                margin: 10px;
            }
            
            .login-logo {
                font-size: 2.5rem;
            }
            
            .login-title {
                font-size: 1.4rem;
            }
            
            .login-input {
                padding: 12px;
                font-size: 0.9rem;
            }
        }
        
        /* =========================================== */
        /* إعدادات الطباعة من الحاسوب - A4 وجه واحد */
        /* =========================================== */
        @media print {
            body * {
                visibility: hidden;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            #printableArea, #printableArea * {
                visibility: visible !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
            }
            
            #printableArea {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 21cm !important;
                height: 29.7cm !important;
                margin: 0 !important;
                padding: 1.5cm !important;
                background: white !important;
                z-index: 999999 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                font-family: 'Arial', 'Segoe UI', sans-serif !important;
                color: #000 !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .no-print, 
            header, 
            .nav-tabs, 
            .page-title, 
            .action-buttons,
            .alert,
            .telegram-badge,
            .search-box,
            .watermark,
            .calendar-controls,
            .calendar-legends,
            .logo,
            .date-display,
            #login-page {
                display: none !important;
                visibility: hidden !important;
            }
            
            @page {
                size: A4 portrait !important;
                margin: 1.5cm !important;
            }
            
            html, body {
                width: 21cm !important;
                height: 29.7cm !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
                background: white !important;
            }
            
            /* تصميم محتوى الطباعة */
            .print-content {
                width: 100% !important;
                height: 100% !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .print-header {
                text-align: center !important;
                margin-bottom: 20px !important;
                padding-bottom: 15px !important;
                border-bottom: 3px solid #2c5f2d !important;
            }
            
            .print-header h2 {
                font-size: 24pt !important;
                color: #2c5f2d !important;
                margin-bottom: 5px !important;
            }
            
            .print-header p {
                font-size: 14pt !important;
                color: #666 !important;
            }
            
            .print-logo {
                font-size: 36pt !important;
                color: #2c5f2d !important;
                margin-bottom: 10px !important;
            }
            
            .print-details {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 15px !important;
                margin-bottom: 15px !important;
            }
            
            .print-section {
                flex: 1 !important;
                min-width: 300px !important;
                margin-bottom: 15px !important;
            }
            
            .print-title {
                font-size: 16pt !important;
                font-weight: bold !important;
                color: #2c5f2d !important;
                margin-bottom: 10px !important;
                padding-bottom: 5px !important;
                border-bottom: 1px solid #ddd !important;
            }
            
            .print-row {
                display: flex !important;
                margin-bottom: 8px !important;
                font-size: 12pt !important;
            }
            
            .print-label {
                font-weight: bold !important;
                min-width: 130px !important;
                color: #333 !important;
            }
            
            .print-value {
                flex: 1 !important;
                color: #000 !important;
            }
            
            .print-tag {
                display: inline-block !important;
                padding: 4px 10px !important;
                background-color: #2c5f2d !important;
                color: white !important;
                border-radius: 15px !important;
                margin-left: 5px !important;
                font-size: 10pt !important;
                font-weight: bold !important;
            }
            
            .print-amount {
                background-color: #f0f8f0 !important;
                padding: 12px !important;
                border-radius: 8px !important;
                border-right: 3px solid #2c5f2d !important;
                margin-bottom: 15px !important;
            }
            
            .print-notes {
                background-color: #f9f9f9 !important;
                padding: 10px !important;
                border-radius: 6px !important;
                border: 1px solid #eee !important;
                margin-bottom: 15px !important;
                font-size: 12pt !important;
            }
            
            .print-signature {
                margin-top: 20px !important;
                padding-top: 15px !important;
                border-top: 1px solid #ddd !important;
            }
            
            .signature-line {
                height: 50px !important;
                border-bottom: 1px solid #999 !important;
                margin-bottom: 10px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 12pt !important;
                color: #666 !important;
            }
            
            .print-terms {
                background-color: #f9f9f9 !important;
                padding: 10px !important;
                border-radius: 6px !important;
                border: 1px solid #eee !important;
                margin-top: 15px !important;
            }
            
            .print-terms h4 {
                text-align: center !important;
                font-size: 14pt !important;
                color: #2c5f2d !important;
                margin-bottom: 8px !important;
            }
            
            .print-terms ul {
                padding-right: 20px !important;
                margin: 0 !important;
            }
            
            .print-terms li {
                margin-bottom: 5px !important;
                font-size: 10pt !important;
                line-height: 1.3 !important;
            }
            
            .print-footer {
                text-align: center !important;
                margin-top: 15px !important;
                padding-top: 10px !important;
                border-top: 1px solid #ddd !important;
                font-size: 10pt !important;
                color: #666 !important;
            }
            
            /* إخفاء محتوى العرسان من الطباعة */
            .print-section:nth-child(2) {
                display: none !important;
            }
        }
        
        /* =========================================== */
        /* محتوى الطباعة للهاتف - A4 وجه واحد */
        /* =========================================== */
        .print-mobile-content {
            display: none;
            width: 21cm;
            height: 29.7cm;
            padding: 1.5cm;
            background: white;
            font-family: 'Arial', sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -9999;
        }
        
        /* ==================== إضافة أنماط PWA ==================== */
        .install-pwa-banner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            text-align: center;
            animation: slideUp 0.5s ease;
            max-width: 400px;
            margin: 0 auto;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-pwa-banner p {
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .install-pwa-banner button {
            background: white;
            color: var(--primary);
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .install-pwa-banner button:hover {
            background: var(--secondary);
            color: white;
        }
        
        .offline-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #ff9800;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";

        // إعدادات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyC7gPDDufyshQ50-lPN09KkIwZQUuc8yiU",
            authDomain: "alnas-5cf4b.firebaseapp.com",
            projectId: "alnas-5cf4b",
            storageBucket: "alnas-5cf4b.firebasestorage.app",
            messagingSenderId: "173426991551",
            appId: "1:173426991551:web:02e522e583a233e801c10a",
            measurementId: "G-4EMW3FKMHZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // جعل Firebase متاحاً عالمياً
        window.firebaseApp = app;
        window.firestore = db;
        window.firebaseModules = {
            collection, addDoc, getDocs, updateDoc, deleteDoc, doc, 
            query, where, orderBy, onSnapshot
        };
        
        console.log("✅ Firebase initialized successfully");
    </script>
</head>
<body>
    <!-- شريط حالة عدم الاتصال -->
    <div class="offline-badge" id="offlineBadge">
        <i class="fas fa-wifi-slash"></i> أنت غير متصل بالإنترنت
    </div>
    
    <!-- شريط تثبيت التطبيق -->
    <div id="installPWA" class="install-pwa-banner" style="display: none;">
        <p><i class="fas fa-download"></i> ثبّت تطبيق قاعة النخيل على جهازك لاستخدامه بدون إنترنت</p>
        <div>
            <button id="installPWAButton">تثبيت التطبيق</button>
            <button id="closeInstallBanner">ليس الآن</button>
        </div>
    </div>
    
    <!-- ==================== صفحة تسجيل الدخول ==================== -->
    <div id="login-page">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-palette"></i>
            </div>
            <h1 class="login-title">قاعة النخيل للمناسبات</h1>
            <p class="login-subtitle">نظام إدارة الحجوزات الإلكتروني</p>
            
            <div id="login-error" class="login-error">
                كلمة المرور غير صحيحة. الرجاء المحاولة مرة أخرى.
            </div>
            
            <form id="loginForm" class="login-form">
                <input type="password" 
                       id="passwordInput" 
                       class="login-input" 
                       placeholder="أدخل كلمة المرور" 
                       maxlength="6" 
                       autocomplete="off"
                       required>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                </button>
                
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">تذكر تسجيل الدخول على هذا الجهاز</label>
                </div>
            </form>
            
            <div class="login-instructions">
                <h4><i class="fas fa-info-circle"></i> معلومات تسجيل الدخول</h4>
                <p>  <strong></strong></p>
                <p>سيتم حفظ حالة تسجيل الدخول على هذا الجهاز لمدة 30 يوماً عند تفعيل خيار "تذكر تسجيل الدخول"</p>
            </div>
        </div>
    </div>
    
    <!-- ==================== التطبيق الرئيسي (مخفي قبل تسجيل الدخول) ==================== -->
    <div class="main-app">
        <!-- ترويسة الموقع -->
        <header>
            <div class="container header-content">
                <div class="logo">
                    <i class="fas fa-palette"></i>
                    <div>
                        <h1>قاعة النخيل للمناسبات</h1>
                        <p>نظام إدارة الحجوزات الإلكتروني</p>
                        <div class="telegram-badge">
                            <i class="fab fa-telegram"></i>
                            متصل ببوت تليجرام
                        </div>
                    </div>
                </div>
                <div class="date-display" id="currentDate">
                    <!-- سيتم تعبئته بواسطة الجافاسكريبت -->
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="loginStatus" style="font-size: 0.9rem; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 4px;">
                        <i class="fas fa-user-check"></i> مسجل الدخول
                    </span>
                    <button id="logoutBtn" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                    </button>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- أشرطة التنقل -->
            <div class="nav-tabs">
                <div class="nav-tab active" data-page="booking-form">
                    <i class="fas fa-calendar-plus"></i> حجز جديد
                </div>
                <div class="nav-tab" data-page="preview-page">
                    <i class="fas fa-eye"></i> معاينة الحجز
                </div>
                <div class="nav-tab" data-page="reservations-calendar">
                    <i class="fas fa-calendar-alt"></i> تقويم الحجوزات
                </div>
                <div class="nav-tab" data-page="today-reservations">
                    <i class="fas fa-heart"></i> عرسان اليوم
                </div>
                <div class="nav-tab" data-page="reservations-list">
                    <i class="fas fa-list"></i> قائمة الحجوزات
                </div>
            </div>
            
            <!-- رسائل التنبيه -->
            <div id="alertMessage" class="alert"></div>
            
            <!-- نموذج الحجز -->
            <div id="booking-form" class="page active">
                <h2 class="page-title"><i class="fas fa-edit"></i> نموذج حجز جديد</h2>
                
                <form id="reservationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName" class="required">اسم السيد المحجِز</label>
                            <input type="text" id="customerName" required placeholder="أدخل الاسم الكامل">
                        </div>
                        
                        <div class="form-group">
                            <label for="phone" class="required">رقم الهاتف</label>
                            <input type="tel" id="phone" required placeholder="مثال: 07701234567">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="groomName">اسم العريس (لحفلات الزفاف)</label>
                            <input type="text" id="groomName" placeholder="أدخل اسم العريس">
                        </div>
                        
                        <div class="form-group">
                            <label for="brideName">اسم العروس (لحفلات الزفاف)</label>
                            <input type="text" id="brideName" placeholder="أدخل اسم العروس">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="groomAddress">عنوان العريس</label>
                            <input type="text" id="groomAddress" placeholder="أدخل عنوان العريس الكامل">
                        </div>
                        
                        <div class="form-group">
                            <label for="brideAddress">عنوان العروس</label>
                            <input type="text" id="brideAddress" placeholder="أدخل عنوان العروس الكامل">
                        </div>
                    </div>
                    
                    <!-- خدمة التصوير - البسيطة -->
                    <div class="photography-section">
                        <div class="detail-title">
                            <i class="fas fa-camera"></i> خدمة التصوير
                        </div>
                        <div class="photography-options-simple">
                            <div class="photography-option-simple">
                                <input type="radio" id="photographyAdd" name="photography" value="اضافة تصوير">
                                <label for="photographyAdd" class="add-photo">
                                    <i class="fas fa-camera"></i> إضافة تصوير
                                </label>
                            </div>
                            <div class="photography-option-simple">
                                <input type="radio" id="photographyNone" name="photography" value="بدون تصوير" checked>
                                <label for="photographyNone" class="no-photo">
                                    <i class="fas fa-times"></i> بدون تصوير
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDate" class="required">تاريخ الحفل</label>
                            <input type="date" id="eventDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="eventType" class="required">نوع المناسبة</label>
                            <select id="eventType" required>
                                <option value="">اختر نوع المناسبة</option>
                                <option value="عرس">عرس</option>
                                <option value="خطوبة">خطوبة</option>
                                <option value="حفلة خاصة">حفلة خاصة</option>
                                <option value="عيد ميلاد">عيد ميلاد</option>
                                <option value="مناسبة رسمية">مناسبة رسمية</option>
                                <option value="مؤتمر">مؤتمر</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventTime" class="required">وقت المناسبة</label>
                            <select id="eventTime" required>
                                <option value="">اختر وقت المناسبة</option>
                                <option value="صباحي">صباحي</option>
                                <option value="عصري">عصري</option>
                                <option value="مسائي">مسائي</option>
                                <option value="كامل اليوم">كامل اليوم</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">القاعة المطلوبة</label>
                            <div class="select-all">
                                <input type="checkbox" id="selectAllHalls">
                                <label for="selectAllHalls">تحديد الكل (حجز القاعتين معاً)</label>
                            </div>
                            <div class="hall-options">
                                <div class="hall-option">
                                    <input type="checkbox" id="hall1" name="hall" value="القاعة رقم 1">
                                    <label for="hall1">
                                        القاعة رقم 1
                                        <div class="hall-badge">سعة 300 شخص</div>
                                    </label>
                                </div>
                                <div class="hall-option">
                                    <input type="checkbox" id="hall2" name="hall" value="القاعة رقم 2">
                                    <label for="hall2">
                                        القاعة رقم 2
                                        <div class="hall-badge">سعة 250 شخص</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalAmount" class="required">المبلغ الكلي (دينار عراقي)</label>
                            <input type="number" id="totalAmount" required placeholder="أدخل المبلغ الكلي">
                        </div>
                        
                        <div class="form-group">
                            <label for="paidAmount" class="required">المبلغ الواصل (دينار عراقي)</label>
                            <input type="number" id="paidAmount" required placeholder="أدخل المبلغ المدفوع">
                        </div>
                        
                        <div class="form-group">
                            <label for="remainingAmount">المبلغ المتبقي (دينار عراقي)</label>
                            <input type="number" id="remainingAmount" readonly placeholder="سيتم حسابه تلقائياً">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="notes">ملاحظات إضافية</label>
                            <textarea id="notes" rows="3" placeholder="أي ملاحظات أو متطلبات خاصة"></textarea>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" id="clearForm">
                            <i class="fas fa-eraser"></i> مسح النموذج
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitForm">
                            <i class="fas fa-save"></i> حفظ الحجز
                        </button>
                        <button type="button" class="btn btn-success" id="previewBtn">
                            <i class="fas fa-eye"></i> معاينة الحجز
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- صفحة المعاينة -->
            <div id="preview-page" class="page">
                <h2 class="page-title"><i class="fas fa-print"></i> معاينة الحجز وطباعته</h2>
                
                <!-- محتوى المعاينة العادي -->
                <div class="preview-container">
                    <div class="preview-header">
                        <div class="preview-logo">
                            <i class="fas fa-palette"></i>
                        </div>
                        <h2>قاعة النخيل للمناسبات</h2>
                        <p>عقد حجز قاعة للمناسبات - نسخة الزبون</p>
                    </div>
                    
                    <div class="preview-content print-optimized">
                        <!-- الجانب الأيمن - تفاصيل الحجز -->
                        <div class="preview-right">
                            <div class="detail-section">
                                <div class="detail-title">
                                    <i class="fas fa-user"></i> معلومات الحجز
                                </div>
                                <div class="detail-content">
                                    <div class="detail-row">
                                        <span class="detail-label">اسم السيد المحجِز:</span>
                                        <span class="detail-value" id="previewCustomerName">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">رقم الحجز:</span>
                                        <span class="detail-value" id="previewReservationId">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">تاريخ الحجز:</span>
                                        <span class="detail-value" id="previewBookingDate">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">رقم الهاتف:</span>
                                        <span class="detail-value" id="previewPhone">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <div class="detail-title">
                                    <i class="fas fa-camera"></i> خدمة التصوير
                                </div>
                                <div class="detail-content">
                                    <div id="previewPhotographySelection" style="margin-bottom: 5px;">بدون تصوير</div>
                                    <div id="previewPhotographyBadges"></div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <div class="detail-title">
                                    <i class="fas fa-calendar-check"></i> تفاصيل المناسبة
                                </div>
                                <div class="detail-content">
                                    <div class="detail-row">
                                        <span class="detail-label">نوع المناسبة:</span>
                                        <span class="detail-value" id="previewEventType">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">التاريخ:</span>
                                        <span class="detail-value" id="previewEventDate">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">الوقت:</span>
                                        <span class="detail-value" id="previewEventTime">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- الجانب الأيسر - القاعة والمال والتفاصيل -->
                        <div class="preview-left">
                            <div class="detail-section">
                                <div class="detail-title">
                                    <i class="fas fa-building"></i> القاعة المختارة
                                </div>
                                <div class="detail-content">
                                    <div id="previewHallSelection" style="margin-bottom: 8px;">لم يتم اختيار قاعة</div>
                                    <div id="previewHallBadges"></div>
                                </div>
                            </div>
                            
                            <div class="detail-section amount-display">
                                <div class="detail-title">
                                    <i class="fas fa-money-bill-wave"></i> التفاصيل المالية
                                </div>
                                <div class="detail-content">
                                    <div class="detail-row">
                                        <span class="detail-label">المبلغ الكلي:</span>
                                        <span class="detail-value" id="previewTotalAmount">0</span> د.ع
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">المبلغ الواصل:</span>
                                        <span class="detail-value" id="previewPaidAmount">0</span> د.ع
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">المبلغ المتبقي:</span>
                                        <span class="detail-value" id="previewRemainingAmount">0</span> د.ع
                                    </div>
                                </div>
                            </div>
                            
                            <div class="notes-section">
                                <div class="detail-title">
                                    <i class="fas fa-sticky-note"></i> الملاحظات
                                </div>
                                <div class="detail-content" style="margin-top: 8px; min-height: 50px;">
                                    <span id="previewNotes">لا توجد ملاحظات</span>
                                </div>
                            </div>
                            
                            <div class="signature-area">
                                <div class="detail-title">
                                    <i class="fas fa-signature"></i> توقيع الطرفين
                                </div>
                                
                                <div style="margin-top: 10px;">
                                    <div class="detail-row" style="margin-bottom: 10px;">
                                        <span class="detail-label">توقيع السيد:</span>
                                        <span class="detail-value">
                                            <div class="signature-box" id="customerSignatureBox">
                                                <span>.......................</span>
                                            </div>
                                        </span>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <span class="detail-label">توقيع المسؤول:</span>
                                        <span class="detail-value">
                                            <div class="signature-box">
                                                <span>إدارة قاعة النخيل</span>
                                            </div>
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 10px; font-size: 0.85rem;">
                                    <input type="checkbox" id="agreeTerms">
                                    <label for="agreeTerms">أوافق على جميع الشروط والأحكام المذكورة</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 0 20px 15px;">
                        <div class="terms">
                            <h4>الشروط والأحكام:</h4>
                            <ul>
                                <li>يتم دفع 50% من قيمة الحجز كعربون عند التوقيع على العقد.</li>
                                <li>في حال الإلغاء قبل 15 يوم من الموعد، يسترد 50% من العربون.</li>
                                <li>قاعة النخيل غير مسؤولة عن فقدان الأشياء الشخصية داخل القاعة.</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 6px; border: 1px solid #ddd; font-size: 0.85rem;">
                            <div class="detail-title" style="border-bottom: none; margin-bottom: 5px; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> معلومات هامة
                            </div>
                            <div class="detail-content">
                                <div class="detail-row">
                                    <span class="detail-label">رقم الهاتف:</span>
                                    <span class="detail-value">07701234567</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">العنوان:</span>
                                    <span class="detail-value">بغداد، المنصور</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">حالة الحجز:</span>
                                    <span class="detail-value" style="color: var(--success); font-weight: bold;">مؤكد</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center; font-size: 0.8rem; color: var(--gray); padding: 8px; border-top: 1px solid #eee;">
                            <p>شكراً لاختياركم قاعة النخيل للمناسبات</p>
                            <p style="margin-top: 5px; font-size: 0.75rem;">هذه النسخة للزبون - الرجاء الاحتفاظ بها</p>
                        </div>
                    </div>
                </div>
                
                <!-- محتوى الطباعة المنفصل (مخفي) -->
                <div id="printableArea" style="display: none;"></div>
                <div id="printMobileContent" class="print-mobile-content"></div>
                
                <div class="action-buttons no-print">
                    <button class="btn btn-secondary" id="backToForm">
                        <i class="fas fa-arrow-right"></i> العودة للنموذج
                    </button>
                    <button class="btn btn-success" id="printDesktopBtn">
                        <i class="fas fa-desktop"></i> الطباعة من الحاسوب
                    </button>
                    <button class="btn btn-phone" id="printMobileBtn">
                        <i class="fas fa-mobile-alt"></i> الطباعة من الهاتف
                    </button>
                    <button class="btn btn-telegram" id="sendToTelegram">
                        <i class="fab fa-telegram"></i> إرسال للتليجرام
                    </button>
                    <button class="btn btn-primary" id="saveReservation">
                        <i class="fas fa-save"></i> حفظ الحجز
                    </button>
                </div>
            </div>
            
            <!-- صفحة تقويم الحجوزات -->
            <div id="reservations-calendar" class="page">
                <h2 class="page-title"><i class="fas fa-calendar-alt"></i> تقويم الحجوزات</h2>
                
                <div class="calendar-controls">
                    <div class="calendar-navigation">
                        <button class="btn btn-secondary" id="prevMonth">
                            <i class="fas fa-chevron-right"></i> الشهر السابق
                        </button>
                        <div class="month-year" id="currentMonthYear">حزيران 2024</div>
                        <button class="btn btn-secondary" id="nextMonth">
                            الشهر التالي <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary" id="todayBtn">
                        <i class="fas fa-calendar-day"></i> الشهر الحالي
                    </button>
                </div>
                
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-header-cell">الأحد</div>
                        <div class="calendar-header-cell">الاثنين</div>
                        <div class="calendar-header-cell">الثلاثاء</div>
                        <div class="calendar-header-cell">الأربعاء</div>
                        <div class="calendar-header-cell">الخميس</div>
                        <div class="calendar-header-cell">الجمعة</div>
                        <div class="calendar-header-cell">السبت</div>
                    </div>
                    <div class="calendar-body" id="calendarBody">
                        <!-- سيتم تعبئته بواسطة JavaScript -->
                    </div>
                </div>
                
                <div class="calendar-legends">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(220, 53, 69, 0.9);"></div>
                        <span>القاعة رقم 1 محجوزة</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(0, 123, 255, 0.9);"></div>
                        <span>القاعة رقم 2 محجوزة</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(255, 193, 7, 0.9);"></div>
                        <span>القاعتين محجوزتان</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(156, 39, 176, 0.9);"></div>
                        <span>قاعة 1 مرة ثانية (1x)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(76, 175, 80, 0.9);"></div>
                        <span>قاعة 2 مرة ثانية (2x)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(44, 95, 45, 0.1); border: 2px solid #2c5f2d;"></div>
                        <span>اليوم الحالي</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="refreshCalendar">
                        <i class="fas fa-sync-alt"></i> تحديث التقويم
                    </button>
                    <button class="btn btn-success" id="printCalendar">
                        <i class="fas fa-print"></i> طباعة التقويم
                    </button>
                </div>
            </div>
            
            <!-- صفحة عرسان اليوم -->
            <div id="today-reservations" class="page">
                <h2 class="page-title"><i class="fas fa-heart"></i> عرسان اليوم</h2>
                
                <div class="brides-controls">
                    <div class="date-selector">
                        <input type="date" id="specificDate" class="form-control">
                        <button class="btn btn-success" id="showDateReservations">
                            <i class="fas fa-search"></i> عرض حجوزات التاريخ المحدد
                        </button>
                        <button class="btn btn-primary" id="todayBtnSpecial">
                            <i class="fas fa-calendar-day"></i> اليوم الحالي
                        </button>
                    </div>
                    <div class="brides-count" id="bridesCount">
                        جاري التحميل...
                    </div>
                </div>
                
                <div id="bridesTodayContainer">
                    <!-- سيتم تعبئتها بواسطة الجافاسكريبت -->
                </div>
            </div>
            
            <!-- قائمة الحجوزات -->
            <div id="reservations-list" class="page">
                <h2 class="page-title"><i class="fas fa-list-alt"></i> قائمة الحجوزات</h2>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ابحث باسم السيد أو رقم الهاتف أو نوع المناسبة...">
                    <button class="btn btn-secondary" id="searchBtn">
                        <i class="fas fa-search"></i> بحث
                    </button>
                    <button class="btn" id="clearSearch">
                        <i class="fas fa-times"></i> مسح
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="reservations-table compact-table">
                        <thead>
                            <tr>
                                <th>رقم الحجز</th>
                                <th>اسم السيد</th>
                                <th>العريس</th>
                                <th>العروس</th>
                                <th>عنوان العريس</th>
                                <th>عنوان العروس</th>
                                <th>التصوير</th>
                                <th>رقم الهاتف</th>
                                <th>تاريخ الحفل</th>
                                <th>نوع المناسبة</th>
                                <th>القاعة</th>
                                <th>المبلغ الكلي</th>
                                <th>التليجرام</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTableBody">
                            <!-- سيتم تعبئته بواسطة الجافاسكريبت -->
                        </tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="exportReservations">
                        <i class="fas fa-file-export"></i> تصدير البيانات
                    </button>
                    <button class="btn btn-danger" id="deleteAllBtn">
                        <i class="fas fa-trash-alt"></i> حذف الكل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== تسجيل Service Worker و PWA ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/h/service-worker.js')
                    .then(function(registration) {
                        console.log('✅ Service Worker registered with scope:', registration.scope);
                        
                        // التحقق من التحديثات
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            console.log('🔄 Service Worker update found');
                            
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        console.log('🔄 New content available, reload to update');
                                        showAlert('تم تحديث التطبيق. أعد تحميل الصفحة للاستفادة من التحديثات', 'info');
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('❌ Service Worker registration failed:', error);
                    });
                    
                // التحقق من الاتصال بالإنترنت
                updateOnlineStatus();
                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
            });
        }
        
        function updateOnlineStatus() {
            const offlineBadge = document.getElementById('offlineBadge');
            if (navigator.onLine) {
                offlineBadge.style.display = 'none';
                console.log('✅ Online');
            } else {
                offlineBadge.style.display = 'block';
                console.log('❌ Offline');
            }
        }
        
        // ==================== نظام تثبيت PWA ====================
        let deferredPrompt;
        const installBanner = document.getElementById('installPWA');
        const installButton = document.getElementById('installPWAButton');
        const closeBanner = document.getElementById('closeInstallBanner');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // التحقق مما إذا كان المستخدم قد أغلق البانر من قبل
            if (!localStorage.getItem('pwaInstallDismissed')) {
                installBanner.style.display = 'block';
            }
        });
        
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                installBanner.style.display = 'none';
                return;
            }
            
            deferredPrompt.prompt();
            
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            
            deferredPrompt = null;
            installBanner.style.display = 'none';
        });
        
        closeBanner.addEventListener('click', () => {
            installBanner.style.display = 'none';
            localStorage.setItem('pwaInstallDismissed', 'true');
        });
        
        // ==================== نظام تسجيل الدخول ====================
        const CORRECT_PASSWORD = '7788xx';
        const LOGIN_STORAGE_KEY = 'nakhil_login_status';
        const LOGIN_EXPIRY_DAYS = 30;
        
        // التحقق من حالة تسجيل الدخول المحفوظة
        function checkSavedLogin() {
            const savedLogin = localStorage.getItem(LOGIN_STORAGE_KEY);
            if (!savedLogin) return false;
            
            try {
                const loginData = JSON.parse(savedLogin);
                const expiryDate = new Date(loginData.expiry);
                
                // التحقق إذا لم ينتهي الصلاحية
                if (expiryDate > new Date()) {
                    return true;
                } else {
                    // مسح البيانات المنتهية
                    localStorage.removeItem(LOGIN_STORAGE_KEY);
                    return false;
                }
            } catch (error) {
                localStorage.removeItem(LOGIN_STORAGE_KEY);
                return false;
            }
        }
        
        // حفظ حالة تسجيل الدخول
        function saveLoginStatus(rememberMe = false) {
            if (rememberMe) {
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + LOGIN_EXPIRY_DAYS);
                
                const loginData = {
                    loggedIn: true,
                    expiry: expiryDate.toISOString()
                };
                
                localStorage.setItem(LOGIN_STORAGE_KEY, JSON.stringify(loginData));
            } else {
                // لمدة جلسة واحدة فقط (تسجيل مؤقت)
                const expiryDate = new Date();
                expiryDate.setHours(expiryDate.getHours() + 12); // 12 ساعة
                
                const loginData = {
                    loggedIn: true,
                    expiry: expiryDate.toISOString()
                };
                
                localStorage.setItem(LOGIN_STORAGE_KEY, JSON.stringify(loginData));
            }
        }
        
        // تسجيل الخروج
        function logout() {
            localStorage.removeItem(LOGIN_STORAGE_KEY);
            window.location.reload();
        }
        
        // إظهار خطأ تسجيل الدخول
        function showLoginError() {
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'block';
            
            // اهتزاز حقل الإدخال
            const passwordInput = document.getElementById('passwordInput');
            passwordInput.style.borderColor = 'var(--danger)';
            passwordInput.style.animation = 'shake 0.5s';
            
            setTimeout(() => {
                passwordInput.style.animation = '';
                passwordInput.value = '';
                passwordInput.focus();
            }, 500);
            
            // إخفاء الخطأ بعد 3 ثواني
            setTimeout(() => {
                errorDiv.style.display = 'none';
                passwordInput.style.borderColor = 'var(--gray-light)';
            }, 3000);
        }
        
        // تسجيل الدخول الناجح
        function loginSuccess() {
            const loginPage = document.getElementById('login-page');
            const mainApp = document.querySelector('.main-app');
            
            // إخفاء صفحة تسجيل الدخول
            loginPage.style.display = 'none';
            
            // إظهار التطبيق الرئيسي
            mainApp.style.display = 'block';
            
            // تهيئة التطبيق
            initializeApp();
        }
        
        // تهيئة التطبيق بعد تسجيل الدخول
        function initializeApp() {
            // عرض التاريخ الحالي
            const today = new Date();
            document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-IQ', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // تعيين الحد الأدنى لتاريخ الحفل إلى اليوم
            document.getElementById('eventDate').min = today.toISOString().split('T')[0];
            
            // تحديث الجدول والبيانات من Firestore
            loadReservationsFromFirestore();
            updateRemainingAmount();
            
            // تهيئة التقويم
            generateCalendar();
            
            // اختبار اتصال تليجرام
            testTelegramConnection();
        }
        
        // التحقق من تسجيل الدخول عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق أولاً من حالة تسجيل الدخول المحفوظة
            if (checkSavedLogin()) {
                loginSuccess();
                return;
            }
            
            // إذا لم يكن مسجلاً، إعداد مستمعي الأحداث لتسجيل الدخول
            const loginForm = document.getElementById('loginForm');
            const passwordInput = document.getElementById('passwordInput');
            
            // تركيز على حقل كلمة المرور
            passwordInput.focus();
            
            // إرسال النموذج
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const enteredPassword = passwordInput.value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                if (enteredPassword === CORRECT_PASSWORD) {
                    // حفظ حالة تسجيل الدخول
                    saveLoginStatus(rememberMe);
                    
                    // تسجيل الدخول الناجح
                    loginSuccess();
                } else {
                    // إظهار خطأ
                    showLoginError();
                }
            });
            
            // زر تسجيل الخروج
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
            
            // إضافة أنيميشن الاهتزاز
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        });
        
        // بيانات الحجوزات
        let reservations = [];
        let reservationCounter = 0;
        let currentReservationData = null;
        
        // متغيرات التقويم
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        
        // إعدادات تليجرام
        const TELEGRAM_BOT_TOKEN = '8397496793:AAH0h2R3MoKt4YUwWtU7uJCs1N4KB4RRRYM';
        const ADMIN_CHAT_IDS = ['5627350311', '8256049330'];
        
        // سعر إضافة التصوير
        const PHOTOGRAPHY_ADDITIONAL_PRICE = 100000;
        
        // ==================== تحميل الحجوزات من Firestore ====================
        async function loadReservationsFromFirestore() {
            try {
                showAlert('جاري تحميل الحجوزات من السحابة...', 'info');
                
                const reservationsCollection = window.firebaseModules.collection(window.firestore, 'reservations');
                const q = window.firebaseModules.query(reservationsCollection, window.firebaseModules.orderBy('eventDate', 'desc'));
                const querySnapshot = await window.firebaseModules.getDocs(q);
                
                reservations = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    reservations.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                // حساب أعلى رقم حجز
                if (reservations.length > 0) {
                    const maxId = Math.max(...reservations.map(r => {
                        const numId = parseInt(r.reservationNumber) || 0;
                        return numId;
                    }));
                    reservationCounter = maxId;
                } else {
                    reservationCounter = 0;
                }
                
                updateReservationsTable();
                generateCalendar();
                showAlert(`تم تحميل ${reservations.length} حجز من السحابة`, 'success');
                
                // الاستماع للتحديثات الحية
                setupRealtimeListener();
                
            } catch (error) {
                console.error('❌ خطأ في تحميل الحجوزات:', error);
                showAlert('خطأ في تحميل الحجوزات من السحابة. تحقق من اتصالك بالإنترنت', 'error');
                
                // محاولة التحميل من localStorage كنسخة احتياطية
                const localData = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
                reservations = localData;
                if (reservations.length > 0) {
                    reservationCounter = Math.max(...reservations.map(r => r.reservationNumber || 0));
                    updateReservationsTable();
                    generateCalendar();
                    showAlert('تم تحميل النسخة الاحتياطية من الحجوزات', 'info');
                }
            }
        }
        
        // ==================== إعداد الاستماع للتحديثات الحية ====================
        function setupRealtimeListener() {
            try {
                const reservationsCollection = window.firebaseModules.collection(window.firestore, 'reservations');
                const q = window.firebaseModules.query(reservationsCollection, window.firebaseModules.orderBy('eventDate', 'desc'));
                
                window.firebaseModules.onSnapshot(q, (snapshot) => {
                    const updatedReservations = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        updatedReservations.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    reservations = updatedReservations;
                    updateReservationsTable();
                    generateCalendar();
                    // تحديث صفحة عرسان اليوم إذا كانت مفتوحة
                    if (document.getElementById('today-reservations').classList.contains('active')) {
                        loadTodayBrides();
                    }
                }, (error) => {
                    console.error('❌ خطأ في تحديثات الوقت الحقيقي:', error);
                });
                
            } catch (error) {
                console.error('❌ خطأ في إعداد التحديثات الحية:', error);
            }
        }
        
        // ==================== توليد التقويم ====================
        function generateCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            // تحديث عنوان الشهر
            const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
                               "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            document.getElementById('currentMonthYear').textContent = 
                `${monthNames[currentMonth]} ${currentYear}`;
            
            // الحصول على اليوم الأول من الشهر
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = الأحد, 1 = الاثنين, ...
            
            // الأيام الفارغة في بداية الشهر
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarBody.appendChild(emptyDay);
            }
            
            // الأيام الفعلية في الشهر
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // التحقق إذا كان اليوم الحالي
                if (isCurrentMonth && day === today.getDate()) {
                    dayElement.classList.add('today');
                }
                
                // رقم اليوم
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                // الحجوزات لهذا اليوم
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayReservations = getReservationsForDate(dateStr);
                
                if (dayReservations.length > 0) {
                    const reservationsList = document.createElement('div');
                    reservationsList.className = 'reservations-list';
                    
                    // تجميع الحجوزات حسب القاعة - النظام الجديد المعدل
                    const bothHallsReservations = dayReservations.filter(r => 
                        Array.isArray(r.halls) && r.halls.length === 2
                    );
                    
                    // الحجوزات الفردية (غير المتضمنة في حجوزات القاعتين)
                    const individualReservations = dayReservations.filter(r => {
                        // استبعاد الحجوزات التي هي جزء من حجز القاعتين معاً
                        if (Array.isArray(r.halls) && r.halls.length === 2) {
                            return false;
                        }
                        return true;
                    });
                    
                    // تجميع الحجوزات الفردية حسب القاعة
                    const hall1Reservations = individualReservations.filter(r => 
                        Array.isArray(r.halls) && r.halls.includes('القاعة رقم 1')
                    );
                    
                    const hall2Reservations = individualReservations.filter(r => 
                        Array.isArray(r.halls) && r.halls.includes('القاعة رقم 2')
                    );
                    
                    // عرض الحجوزات - النظام الجديد المعدل:
                    // 1. عرض حجز القاعتين معاً (1/2) إذا وجد
                    // 2. عرض الحجوزات الفردية للقاعة 1 (1 ثم 1x)
                    // 3. عرض الحجوزات الفردية للقاعة 2 (2 ثم 2x)
                    
                    // عرض حجز القاعتين معاً إذا وجد
                    if (bothHallsReservations.length > 0) {
                        const badge = createReservationBadge('1/2', 'both-halls-badge', bothHallsReservations[0]);
                        reservationsList.appendChild(badge);
                    }
                    
                    // عرض الحجوزات الفردية للقاعة 1
                    if (hall1Reservations.length > 0) {
                        // الحجز الأول للقاعة 1
                        const badge1 = createReservationBadge('1', 'hall1-badge', hall1Reservations[0]);
                        reservationsList.appendChild(badge1);
                        
                        // الحجز الثاني للقاعة 1 - 1x بلون بنفسجي
                        if (hall1Reservations.length > 1) {
                            const badge2 = createReservationBadge('1x', 'hall1-second-badge', hall1Reservations[1]);
                            reservationsList.appendChild(badge2);
                        }
                    }
                    
                    // عرض الحجوزات الفردية للقاعة 2
                    if (hall2Reservations.length > 0) {
                        // الحجز الأول للقاعة 2
                        const badge1 = createReservationBadge('2', 'hall2-badge', hall2Reservations[0]);
                        reservationsList.appendChild(badge1);
                        
                        // الحجز الثاني للقاعة 2 - 2x بلون أخضر
                        if (hall2Reservations.length > 1) {
                            const badge2 = createReservationBadge('2x', 'hall2-second-badge', hall2Reservations[1]);
                            reservationsList.appendChild(badge2);
                        }
                    }
                    
                    dayElement.appendChild(reservationsList);
                }
                
                calendarBody.appendChild(dayElement);
            }
            
            // ملء الأيام المتبقية لتصبح 7 أيام في الأسبوع
            const totalCells = 42; // 6 أسابيع × 7 أيام
            const currentCells = calendarBody.children.length;
            
            for (let i = currentCells; i < totalCells; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarBody.appendChild(emptyDay);
            }
        }
        
        // ==================== الحصول على الحجوزات لتاريخ معين ====================
        function getReservationsForDate(dateStr) {
            return reservations.filter(reservation => {
                if (!reservation.eventDate) return false;
                
                // تحويل التاريخ إلى نفس التنسيق
                const reservationDate = new Date(reservation.eventDate);
                const targetDate = new Date(dateStr);
                
                return reservationDate.toDateString() === targetDate.toDateString();
            });
        }
        
        // ==================== إنشاء شارة الحجز ====================
        function createReservationBadge(text, className, reservation) {
            const badge = document.createElement('div');
            badge.className = `reservation-badge ${className}`;
            badge.textContent = text;
            badge.title = `${reservation.customerName} - ${reservation.eventType}`;
            
            badge.addEventListener('click', function(e) {
                e.stopPropagation();
                showReservationDetails(reservation);
            });
            
            return badge;
        }
        
        // ==================== عرض تفاصيل الحجز ====================
        function showReservationDetails(reservation) {
            const message = `
اسم السيد: ${reservation.customerName}
رقم الهاتف: ${reservation.phone}
نوع المناسبة: ${reservation.eventType}
القاعة: ${Array.isArray(reservation.halls) ? reservation.halls.join(', ') : reservation.halls}
المبلغ الكلي: ${formatCurrency(reservation.totalAmount)} د.ع
خدمة التصوير: ${reservation.photographyServices ? reservation.photographyServices : 'لا يوجد'}
            `;
            
            alert(message);
        }
        
        // ==================== التنقل في التقويم ====================
        document.getElementById('prevMonth')?.addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        });
        
        document.getElementById('nextMonth')?.addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
        });
        
        document.getElementById('todayBtn')?.addEventListener('click', function() {
            currentDate = new Date();
            currentMonth = currentDate.getMonth();
            currentYear = currentDate.getFullYear();
            generateCalendar();
        });
        
        document.getElementById('refreshCalendar')?.addEventListener('click', function() {
            generateCalendar();
            showAlert('تم تحديث التقويم', 'success');
        });
        
        // ==================== التنقل بين الصفحات ====================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');
                
                if (pageId === 'preview-page') {
                    updatePreview();
                }
                
                if (pageId === 'reservations-list') {
                    updateReservationsTable();
                }
                
                if (pageId === 'reservations-calendar') {
                    generateCalendar();
                }
                
                if (pageId === 'today-reservations') {
                    loadTodayBrides();
                }
            });
        });
        
        // ==================== إدارة القاعات ====================
        document.getElementById('selectAllHalls')?.addEventListener('change', function() {
            const hallCheckboxes = document.querySelectorAll('input[name="hall"]');
            hallCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
        });
        
        // ==================== حساب المبلغ المتبقي ====================
        document.getElementById('totalAmount')?.addEventListener('input', updateRemainingAmount);
        document.getElementById('paidAmount')?.addEventListener('input', updateRemainingAmount);
        
        function updateRemainingAmount() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
            const remaining = total - paid;
            document.getElementById('remainingAmount').value = remaining > 0 ? remaining : 0;
        }
        
        // ==================== أزرار النموذج ====================
        document.getElementById('clearForm')?.addEventListener('click', function() {
            if (confirm('هل تريد مسح جميع بيانات النموذج؟')) {
                document.getElementById('reservationForm').reset();
                updateRemainingAmount();
                // إعادة تعيين التصوير
                document.getElementById('photographyNone').checked = true;
            }
        });
        
        document.getElementById('previewBtn')?.addEventListener('click', function() {
            if (!validateForm()) {
                showAlert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }
            
            // حفظ بيانات النموذج مؤقتاً
            currentReservationData = getFormData();
            
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-page="preview-page"]').classList.add('active');
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('preview-page').classList.add('active');
            
            updatePreview();
            updatePrintContent();
        });
        
        // ==================== العودة للنموذج ====================
        document.getElementById('backToForm')?.addEventListener('click', function() {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-page="booking-form"]').classList.add('active');
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('booking-form').classList.add('active');
        });
        
        // ==================== الحصول على بيانات النموذج ====================
        function getFormData() {
            const selectedHalls = Array.from(document.querySelectorAll('input[name="hall"]:checked')).map(cb => cb.value);
            
            // الحصول على بيانات التصوير
            const photographyAdd = document.getElementById('photographyAdd');
            const photographyService = photographyAdd.checked ? 'إضافة تصوير' : 'بدون تصوير';
            
            return {
                customerName: document.getElementById('customerName').value,
                phone: document.getElementById('phone').value,
                groomName: document.getElementById('groomName').value || '',
                brideName: document.getElementById('brideName').value || '',
                groomAddress: document.getElementById('groomAddress').value || '',
                brideAddress: document.getElementById('brideAddress').value || '',
                photographyServices: photographyService,
                eventDate: document.getElementById('eventDate').value,
                eventType: document.getElementById('eventType').value,
                eventTime: document.getElementById('eventTime').value,
                halls: selectedHalls,
                totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                paidAmount: parseFloat(document.getElementById('paidAmount').value) || 0,
                remainingAmount: parseFloat(document.getElementById('remainingAmount').value) || 0,
                notes: document.getElementById('notes').value,
                bookingDate: new Date().toISOString().split('T')[0],
                telegramSent: false,
                telegramSentAt: null,
                status: 'مؤكد'
            };
        }
        
        // ==================== تحديث صفحة المعاينة ====================
        function updatePreview() {
            const data = currentReservationData || getFormData();
            
            // معلومات الحجز الأساسية
            document.getElementById('previewCustomerName').textContent = data.customerName;
            document.getElementById('previewPhone').textContent = data.phone;
            document.getElementById('previewBookingDate').textContent = new Date().toLocaleDateString('ar-IQ');
            
            // خدمة التصوير
            const photographySelection = document.getElementById('previewPhotographySelection');
            const photographyBadges = document.getElementById('previewPhotographyBadges');
            
            photographyBadges.innerHTML = '';
            
            if (data.photographyServices === 'إضافة تصوير') {
                photographySelection.textContent = 'نعم، مطلوب خدمة تصوير';
                photographySelection.style.color = 'var(--info)';
                photographySelection.style.fontWeight = 'bold';
                
                const badge = document.createElement('span');
                badge.className = 'photography-tag';
                badge.textContent = 'خدمة تصوير';
                photographyBadges.appendChild(badge);
            } else {
                photographySelection.textContent = 'بدون تصوير';
                photographySelection.style.color = 'var(--gray)';
            }
            
            // تفاصيل المناسبة
            document.getElementById('previewEventType').textContent = data.eventType;
            document.getElementById('previewEventDate').textContent = formatDate(data.eventDate);
            document.getElementById('previewEventTime').textContent = data.eventTime;
            
            // القاعة المختارة
            const selectedHalls = Array.isArray(data.halls) ? data.halls : [data.halls];
            const hallSelection = document.getElementById('previewHallSelection');
            const hallBadges = document.getElementById('previewHallBadges');
            
            hallBadges.innerHTML = '';
            
            if (selectedHalls.length === 0 || selectedHalls[0] === '') {
                hallSelection.textContent = 'لم يتم اختيار قاعة';
            } else if (selectedHalls.length === 2) {
                hallSelection.textContent = 'تم حجز القاعتين معاً';
                hallBadges.innerHTML = '<span class="hall-tag">القاعة 1</span><span class="hall-tag">القاعة 2</span>';
            } else {
                hallSelection.textContent = selectedHalls.join(', ');
                selectedHalls.forEach(hall => {
                    const badge = document.createElement('span');
                    badge.className = 'hall-tag';
                    badge.textContent = hall === 'القاعة رقم 1' ? 'القاعة 1' : 'القاعة 2';
                    hallBadges.appendChild(badge);
                });
            }
            
            // التفاصيل المالية
            document.getElementById('previewTotalAmount').textContent = formatCurrency(data.totalAmount || '0');
            document.getElementById('previewPaidAmount').textContent = formatCurrency(data.paidAmount || '0');
            document.getElementById('previewRemainingAmount').textContent = formatCurrency(data.remainingAmount || '0');
            
            // الملاحظات
            const notes = data.notes;
            document.getElementById('previewNotes').textContent = notes || 'لا توجد ملاحظات';
            
            // رقم الحجز
            document.getElementById('previewReservationId').textContent = reservationCounter + 1;
            
            // توقيع الزبون
            const signatureBox = document.getElementById('customerSignatureBox');
            signatureBox.innerHTML = '<span>.......................</span>';
        }
        
        // ==================== تحديث محتوى الطباعة ====================
        function updatePrintContent() {
            const data = currentReservationData || getFormData();
            const printableArea = document.getElementById('printableArea');
            const printMobileContent = document.getElementById('printMobileContent');
            
            const customerName = data.customerName;
            const phone = data.phone;
            const photographyServices = data.photographyServices;
            const eventType = data.eventType;
            const eventDate = formatDate(data.eventDate);
            const eventTime = data.eventTime;
            const selectedHalls = Array.isArray(data.halls) ? data.halls : [data.halls];
            const totalAmount = data.totalAmount || '0';
            const paidAmount = data.paidAmount || '0';
            const remainingAmount = data.remainingAmount || '0';
            const notes = data.notes;
            
            let hallTags = '';
            if (selectedHalls.length === 2) {
                hallTags = '<span class="print-tag">القاعة 1</span> <span class="print-tag">القاعة 2</span>';
            } else if (selectedHalls.length === 1 && selectedHalls[0] !== '') {
                hallTags = `<span class="print-tag">${selectedHalls[0] === 'القاعة رقم 1' ? 'القاعة 1' : 'القاعة 2'}</span>`;
            }
            
            let photographyTag = '';
            if (photographyServices === 'إضافة تصوير') {
                photographyTag = '<span class="print-tag" style="background-color: #17a2b8;">خدمة تصوير</span>';
            }
            
            const printHTML = `
                <div class="print-content">
                    <div class="print-header">
                        <div class="print-logo">
                            <i class="fas fa-palette"></i>
                        </div>
                        <h2 style="font-size: 22pt; margin-bottom: 5px;">قاعة النخيل للمناسبات</h2>
                        <p style="font-size: 12pt; color: #666;">عقد حجز قاعة للمناسبات - نسخة الزبون</p>
                        <div style="margin-top: 10px; padding: 5px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; font-size: 10pt;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>رقم الحجز: ${reservationCounter + 1}</span>
                                <span>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-IQ')}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-details">
                        <div class="print-section" style="flex: 2; min-width: 250px;">
                            <div class="print-title" style="font-size: 14pt;">معلومات الحجز</div>
                            <div class="print-row">
                                <div class="print-label" style="min-width: 100px;">اسم السيد المحجِز:</div>
                                <div class="print-value">${customerName || '-'}</div>
                            </div>
                            <div class="print-row">
                                <div class="print-label" style="min-width: 100px;">رقم الهاتف:</div>
                                <div class="print-value">${phone || '-'}</div>
                            </div>
                            <div class="print-row">
                                <div class="print-label" style="min-width: 100px;">خدمة التصوير:</div>
                                <div class="print-value">${photographyServices === 'إضافة تصوير' ? 'مطلوب خدمة تصوير' : 'بدون تصوير'} ${photographyTag}</div>
                            </div>
                        </div>
                        
                        <div class="print-section" style="flex: 2; min-width: 250px;">
                            <div class="print-title" style="font-size: 14pt;">تفاصيل المناسبة</div>
                            <div class="print-row">
                                <div class="print-label" style="min-width: 100px;">نوع المناسبة:</div>
                                <div class="print-value">${eventType || '-'}</div>
                            </div>
                            <div class="print-row">
                                <div class="print-label" style="min-width: 100px;">التاريخ:</div>
                                <div class="print-value">${eventDate || '-'}</div>
                            </div>
                            <div class="print-row">
                                <div class="print-label" style="min-width: 100px;">الوقت:</div>
                                <div class="print-value">${eventTime || '-'}</div>
                            </div>
                        </div>
                        
                        <div class="print-section" style="flex: 1.5; min-width: 200px;">
                            <div class="print-title" style="font-size: 14pt;">القاعة المختارة</div>
                            <div class="print-row">
                                <div class="print-label" style="min-width: 90px;">القاعات:</div>
                                <div class="print-value">${selectedHalls.length > 0 && selectedHalls[0] !== '' ? selectedHalls.join(', ') : 'لم يتم اختيار قاعة'} ${hallTags}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-amount" style="padding: 10px; margin-bottom: 15px;">
                        <div class="print-title" style="font-size: 14pt;">التفاصيل المالية</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 3px;">المبلغ الكلي:</div>
                                <div style="font-size: 12pt;">${formatCurrency(totalAmount)} د.ع</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 3px;">المبلغ الواصل:</div>
                                <div style="font-size: 12pt;">${formatCurrency(paidAmount)} د.ع</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 3px;">المبلغ المتبقي:</div>
                                <div style="font-size: 12pt;">${formatCurrency(remainingAmount)} د.ع</div>
                            </div>
                        </div>
                    </div>
                    
                    ${notes ? `
                    <div class="print-notes" style="padding: 8px; margin-bottom: 12px;">
                        <div class="print-title" style="font-size: 13pt;">ملاحظات إضافية</div>
                        <div class="print-value" style="font-size: 11pt; line-height: 1.4;">${notes}</div>
                    </div>
                    ` : ''}
                    
                    <div class="print-signature" style="margin-top: 15px;">
                        <div class="print-title" style="font-size: 14pt;">توقيع الطرفين</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px; font-size: 11pt;">توقيع السيد:</div>
                                <div class="signature-line" style="height: 40px; font-size: 11pt;">.......................</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px; font-size: 11pt;">توقيع المسؤول:</div>
                                <div class="signature-line" style="height: 40px; font-size: 11pt;">إدارة قاعة النخيل</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-terms" style="margin-top: 15px; padding: 8px;">
                        <h4 style="font-size: 12pt; margin-bottom: 6px;">الشروط والأحكام:</h4>
                        <ul style="padding-right: 15px; margin: 0;">
                            <li style="margin-bottom: 4px; font-size: 9pt; line-height: 1.3;">يتم دفع 50% من قيمة الحجز كعربون عند التوقيع على العقد.</li>
                            <li style="margin-bottom: 4px; font-size: 9pt; line-height: 1.3;">في حال الإلغاء قبل 15 يوم من الموعد، يسترد 50% من العربون.</li>
                            <li style="font-size: 9pt; line-height: 1.3;">قاعة النخيل غير مسؤولة عن فقدان الأشياء الشخصية داخل القاعة.</li>
                        </ul>
                    </div>
                    
                    <div class="print-footer" style="margin-top: 10px; padding-top: 8px; font-size: 9pt;">
                        <p style="margin-bottom: 5px;">شكراً لاختياركم قاعة النخيل للمناسبات</p>
                        <p style="margin-bottom: 3px;">هذه النسخة للزبون - الرجاء الاحتفاظ بها</p>
                        <p>رقم الهاتف: 07701234567 | العنوان: بغداد، المنصور</p>
                    </div>
                </div>
            `;
            
            printableArea.innerHTML = printHTML;
            printMobileContent.innerHTML = printHTML;
        }
        
        // ==================== الطباعة من الحاسوب (مصححة ومضغوطة) ====================
        document.getElementById('printDesktopBtn')?.addEventListener('click', function() {
            if (!document.getElementById('agreeTerms').checked) {
                showAlert('يرجى الموافقة على الشروط والأحكام قبل الطباعة', 'error');
                return;
            }
            
            updatePrintContent();
            
            // إنشاء محتوى الطباعة فقط
            const printContent = document.getElementById('printableArea').innerHTML;
            
            // إنشاء نافذة جديدة للطباعة
            const printWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            
            if (!printWindow) {
                showAlert('يرجى السماح بالنوافذ المنبثقة للطباعة', 'error');
                return;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>طباعة الحجز - قاعة النخيل للمناسبات</title>
                    <style>
                        @page {
                            size: A4 portrait;
                            margin: 0.8cm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            width: 19.4cm; /* 21cm - (0.8cm * 2) */
                            height: 28.1cm; /* 29.7cm - (0.8cm * 2) */
                            margin: 0 auto;
                            padding: 0.8cm;
                            font-family: 'Arial', 'Segoe UI', sans-serif;
                            direction: rtl;
                            background: white;
                            line-height: 1.4;
                            font-size: 10pt;
                        }
                        
                        .print-content {
                            width: 100%;
                            height: 100%;
                            display: flex;
                            flex-direction: column;
                        }
                        
                        .print-header {
                            text-align: center;
                            margin-bottom: 15px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #2c5f2d;
                        }
                        
                        .print-header h2 {
                            font-size: 20pt;
                            color: #2c5f2d;
                            margin-bottom: 5px;
                        }
                        
                        .print-header p {
                            font-size: 11pt;
                            color: #666;
                            margin-bottom: 8px;
                        }
                        
                        .print-logo {
                            font-size: 30pt;
                            color: #2c5f2d;
                            margin-bottom: 8px;
                        }
                        
                        .print-details {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 12px;
                            margin-bottom: 15px;
                        }
                        
                        .print-section {
                            flex: 1;
                            min-width: 200px;
                            margin-bottom: 12px;
                        }
                        
                        .print-title {
                            font-size: 12pt;
                            font-weight: bold;
                            color: #2c5f2d;
                            margin-bottom: 8px;
                            padding-bottom: 4px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .print-row {
                            display: flex;
                            margin-bottom: 6px;
                            font-size: 10pt;
                        }
                        
                        .print-label {
                            font-weight: bold;
                            min-width: 90px;
                            color: #333;
                            font-size: 10pt;
                        }
                        
                        .print-value {
                            flex: 1;
                            color: #000;
                            font-size: 10pt;
                        }
                        
                        .print-tag {
                            display: inline-block;
                            padding: 3px 8px;
                            background-color: #2c5f2d;
                            color: white;
                            border-radius: 12px;
                            margin-right: 4px;
                            font-size: 8pt;
                            font-weight: bold;
                        }
                        
                        .print-amount {
                            background-color: #f0f8f0;
                            padding: 10px;
                            border-radius: 6px;
                            border-right: 3px solid #2c5f2d;
                            margin-bottom: 12px;
                        }
                        
                        .print-notes {
                            background-color: #f9f9f9;
                            padding: 8px;
                            border-radius: 5px;
                            border: 1px solid #eee;
                            margin-bottom: 12px;
                            font-size: 10pt;
                        }
                        
                        .print-signature {
                            margin-top: 15px;
                            padding-top: 12px;
                            border-top: 1px solid #ddd;
                        }
                        
                        .signature-line {
                            height: 35px;
                            border-bottom: 1px solid #999;
                            margin-bottom: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10pt;
                            color: #666;
                        }
                        
                        .print-terms {
                            background-color: #f9f9f9;
                            padding: 8px;
                            border-radius: 5px;
                            border: 1px solid #eee;
                            margin-top: 12px;
                        }
                        
                        .print-terms h4 {
                            text-align: center;
                            font-size: 11pt;
                            color: #2c5f2d;
                            margin-bottom: 6px;
                        }
                        
                        .print-terms ul {
                            padding-right: 15px;
                            margin: 0;
                        }
                        
                        .print-terms li {
                            margin-bottom: 4px;
                            font-size: 8pt;
                            line-height: 1.3;
                        }
                        
                        .print-footer {
                            text-align: center;
                            margin-top: 10px;
                            padding-top: 8px;
                            border-top: 1px solid #ddd;
                            font-size: 8pt;
                            color: #666;
                        }
                        
                        @media print {
                            body {
                                padding: 0.8cm !important;
                                margin: 0 !important;
                                width: 19.4cm !important;
                                height: 28.1cm !important;
                            }
                            button {
                                display: none !important;
                            }
                        }
                        
                        @media screen {
                            body {
                                background: #f5f5f5;
                            }
                            .print-content {
                                background: white;
                                box-shadow: 0 0 15px rgba(0,0,0,0.1);
                                border-radius: 8px;
                                padding: 15px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-content">
                        ${printContent}
                    </div>
                    <button onclick="window.print()" style="position: fixed; top: 20px; left: 20px; padding: 8px 15px; background: #2c5f2d; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial; z-index: 10000;">🖨️ طباعة</button>
                    <button onclick="window.close()" style="position: fixed; top: 20px; left: 120px; padding: 8px 15px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial; z-index: 10000;">✖ إغلاق</button>
                    <script>
                        window.addEventListener('load', function() {
                            setTimeout(function() {
                                window.print();
                            }, 500);
                        });
                        
                        document.addEventListener('keydown', function(e) {
                            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                                e.preventDefault();
                                window.print();
                            }
                            if (e.key === 'Escape') {
                                window.close();
                            }
                        });
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        });
        
        // ==================== الطباعة من الهاتف ====================
        document.getElementById('printMobileBtn')?.addEventListener('click', function() {
            if (!document.getElementById('agreeTerms').checked) {
                showAlert('يرجى الموافقة على الشروط والأحكام قبل الطباعة', 'error');
                return;
            }
            
            updatePrintContent();
            
            // كشف إذا كان الجهاز هاتف
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // فتح نافذة جديدة للطباعة
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>طباعة الحجز - قاعة النخيل</title>
                        <style>
                            @page {
                                size: A4;
                                margin: 0.8cm;
                            }
                            body {
                                width: 19.4cm;
                                margin: 0 auto;
                                font-family: 'Arial', sans-serif;
                                direction: rtl;
                                padding: 0.8cm;
                                box-sizing: border-box;
                                font-size: 10pt;
                            }
                            .print-content {
                                width: 100%;
                            }
                            .print-header {
                                text-align: center;
                                margin-bottom: 15px;
                                padding-bottom: 10px;
                                border-bottom: 2px solid #2c5f2d;
                            }
                            .print-header h2 {
                                font-size: 18pt;
                                color: #2c5f2d;
                                margin-bottom: 5px;
                            }
                            .print-header p {
                                font-size: 10pt;
                                color: #666;
                            }
                            .print-logo {
                                font-size: 25pt;
                                color: #2c5f2d;
                                margin-bottom: 8px;
                            }
                            .print-section {
                                margin-bottom: 12px;
                            }
                            .print-title {
                                font-size: 11pt;
                                font-weight: bold;
                                color: #2c5f2d;
                                margin-bottom: 6px;
                                padding-bottom: 3px;
                                border-bottom: 1px solid #ddd;
                            }
                            .print-row {
                                display: flex;
                                flex-wrap: wrap;
                                margin-bottom: 5px;
                                font-size: 9pt;
                            }
                            .print-label {
                                font-weight: bold;
                                min-width: 80px;
                                color: #333;
                                font-size: 9pt;
                            }
                            .print-value {
                                flex: 1;
                                color: #000;
                                font-size: 9pt;
                            }
                            .print-tag {
                                display: inline-block;
                                padding: 2px 6px;
                                background-color: #2c5f2d;
                                color: white;
                                border-radius: 10px;
                                margin-right: 3px;
                                font-size: 7pt;
                                font-weight: bold;
                            }
                            .print-amount {
                                background-color: #f0f8f0;
                                padding: 8px;
                                border-radius: 5px;
                                border-right: 2px solid #2c5f2d;
                                margin-bottom: 12px;
                            }
                            .print-notes {
                                background-color: #f9f9f9;
                                padding: 6px;
                                border-radius: 4px;
                                border: 1px solid #eee;
                                margin-bottom: 12px;
                                font-size: 9pt;
                            }
                            .print-signature {
                                margin-top: 12px;
                                padding-top: 8px;
                                border-top: 1px solid #ddd;
                            }
                            .signature-line {
                                height: 30px;
                                border-bottom: 1px solid #999;
                                margin-bottom: 6px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 9pt;
                                color: #666;
                            }
                            .print-terms {
                                background-color: #f9f9f9;
                                padding: 6px;
                                border-radius: 4px;
                                border: 1px solid #eee;
                                margin-top: 10px;
                            }
                            .print-terms h4 {
                                text-align: center;
                                font-size: 10pt;
                                color: #2c5f2d;
                                margin-bottom: 5px;
                            }
                            .print-terms ul {
                                padding-right: 12px;
                                margin: 0;
                            }
                            .print-terms li {
                                margin-bottom: 3px;
                                font-size: 7pt;
                                line-height: 1.3;
                            }
                            .print-footer {
                                text-align: center;
                                margin-top: 8px;
                                padding-top: 6px;
                                border-top: 1px solid #ddd;
                                font-size: 7pt;
                                color: #666;
                            }
                            @media print {
                                body {
                                    width: 19.4cm;
                                    height: 28.1cm;
                                    margin: 0;
                                    padding: 0.8cm;
                                }
                                button { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        ${document.getElementById('printableArea').innerHTML}
                        <button onclick="window.print()" style="position: fixed; top: 10px; left: 10px; padding: 6px 12px; background: #2c5f2d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; z-index: 10000;">🖨️ طباعة</button>
                        <button onclick="window.close()" style="position: fixed; top: 10px; left: 90px; padding: 6px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; z-index: 10000;">✖ إغلاق</button>
                        <script>
                            setTimeout(() => {
                                window.print();
                                setTimeout(() => {
                                    window.close();
                                }, 1000);
                            }, 500);
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            } else {
                // إذا كان حاسوب ولكن مستخدم ضغط زر الهاتف
                showAlert('أنت تستخدم حاسوباً، الرجاء استخدام زر "الطباعة من الحاسوب" للحصول على أفضل نتيجة', 'info');
            }
        });
        
        // ==================== إرسال للتليجرام ====================
        document.getElementById('sendToTelegram')?.addEventListener('click', function() {
            if (!validateForm()) {
                showAlert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }
            
            const telegramMessage = formatTelegramMessage();
            sendToAllAdmins(telegramMessage);
        });
        
        // ==================== حفظ الحجز في Firestore ====================
        async function saveReservationToFirestore(reservationData) {
            try {
                reservationCounter++;
                
                // تحضير بيانات الحجز
                const firestoreData = {
                    ...reservationData,
                    reservationNumber: reservationCounter,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // إضافة إلى Firestore
                const docRef = await window.firebaseModules.addDoc(
                    window.firebaseModules.collection(window.firestore, 'reservations'),
                    firestoreData
                );
                
                console.log('✅ تم حفظ الحجز في Firestore:', docRef.id);
                
                // حفظ نسخة احتياطية في localStorage
                const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
                backupReservations.push({
                    id: docRef.id,
                    ...firestoreData
                });
                localStorage.setItem('nakhilReservations_backup', JSON.stringify(backupReservations));
                
                return {
                    success: true,
                    docId: docRef.id,
                    reservationNumber: reservationCounter,
                    data: firestoreData
                };
                
            } catch (error) {
                console.error('❌ خطأ في حفظ الحجز في Firestore:', error);
                
                // محاولة الحفظ في localStorage كنسخة احتياطية
                try {
                    reservationCounter++;
                    reservationData.reservationNumber = reservationCounter;
                    reservationData.createdAt = new Date().toISOString();
                    
                    const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
                    backupReservations.push({
                        id: 'local_' + reservationCounter,
                        ...reservationData
                    });
                    localStorage.setItem('nakhilReservations_backup', JSON.stringify(backupReservations));
                    
                    return {
                        success: true,
                        docId: 'local_' + reservationCounter,
                        reservationNumber: reservationCounter,
                        data: reservationData
                    };
                    
                } catch (localError) {
                    console.error('❌ خطأ في حفظ النسخة الاحتياطية:', localError);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }
        }
        
        // ==================== حفظ الحجز ====================
        document.getElementById('saveReservation')?.addEventListener('click', saveReservation);
        document.getElementById('submitForm')?.addEventListener('click', function(e) {
            e.preventDefault();
            saveReservation();
        });
        
        async function saveReservation() {
            if (!validateForm()) {
                showAlert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }
            
            const reservationData = getFormData();
            
            // حفظ في Firebase
            showAlert('جاري حفظ الحجز في السحابة...', 'info');
            const saveResult = await saveReservationToFirestore(reservationData);
            
            if (!saveResult.success) {
                showAlert('خطأ في حفظ الحجز في السحابة', 'error');
                return;
            }
            
            const reservationNumber = saveResult.reservationNumber;
            
            // إرسال إشعار تليجرام
            let telegramSuccess = false;
            try {
                const telegramMessage = formatTelegramMessage();
                await sendToAllAdmins(telegramMessage);
                telegramSuccess = true;
                
                // تحديث حالة التليجرام في Firestore
                try {
                    await window.firebaseModules.updateDoc(
                        window.firebaseModules.doc(window.firestore, 'reservations', saveResult.docId),
                        {
                            telegramSent: true,
                            telegramSentAt: new Date().toISOString()
                        }
                    );
                } catch (updateError) {
                    console.error('❌ خطأ في تحديث حالة التليجرام:', updateError);
                }
                
            } catch (error) {
                console.error('خطأ في إرسال تليجرام:', error);
            }
            
            // إظهار رسالة نجاح
            showAlert(`تم حفظ الحجز بنجاح! رقم الحجز: ${reservationNumber} ${telegramSuccess ? '✅ (تم الإرسال للتليجرام)' : '⚠️ (لم يتم الإرسال للتليجرام)'}`, 'success');
            
            // مسح النموذج
            document.getElementById('reservationForm').reset();
            updateRemainingAmount();
            currentReservationData = null;
            
            // إعادة تعيين التصوير
            document.getElementById('photographyNone').checked = true;
            
            // تحديث قائمة الحجوزات والتقويم
            updateReservationsTable();
            generateCalendar();
            
            // العودة إلى صفحة الحجز
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-page="booking-form"]').classList.add('active');
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('booking-form').classList.add('active');
        }
        
        // ==================== التحقق من صحة النموذج ====================
        function validateForm() {
            const requiredFields = [
                'customerName',
                'phone',
                'eventDate',
                'eventType',
                'eventTime',
                'totalAmount',
                'paidAmount'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            
            const selectedHalls = document.querySelectorAll('input[name="hall"]:checked');
            if (selectedHalls.length === 0) {
                showAlert('يرجى اختيار قاعة واحدة على الأقل', 'error');
                return false;
            }
            
            return true;
        }
        
        // ==================== صفحة عرسان اليوم الحالي ====================
        function loadTodayBrides() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('specificDate').value = todayStr;
            showReservationsForDate(todayStr);
        }
        
        function showReservationsForDate(dateStr) {
            const container = document.getElementById('bridesTodayContainer');
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('ar-IQ');
            
            // تصفية الحجوزات للتاريخ المحدد
            const dayReservations = reservations.filter(reservation => {
                if (!reservation.eventDate) return false;
                const resDate = new Date(reservation.eventDate);
                return resDate.toDateString() === date.toDateString();
            });
            
            // تصفية فقط الحجوزات التي تحتوي على عرسان
            const bridesReservations = dayReservations.filter(reservation => 
                (reservation.groomName && reservation.groomName.trim() !== '') || 
                (reservation.brideName && reservation.brideName.trim() !== '')
            );
            
            // تحديث العداد
            document.getElementById('bridesCount').textContent = `عدد الحفلات: ${bridesReservations.length}`;
            
            if (bridesReservations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-heart-broken"></i>
                        <h3>لا توجد حفلات عرس في ${formattedDate}</h3>
                        <p>لا توجد حجوزات تحتوي على عرسان لهذا التاريخ</p>
                    </div>
                `;
                return;
            }
            
            // تجميع الحجوزات حسب القاعة
            const bothHallsReservations = bridesReservations.filter(r => 
                Array.isArray(r.halls) && r.halls.length === 2
            );
            
            const individualReservations = bridesReservations.filter(r => {
                if (Array.isArray(r.halls) && r.halls.length === 2) {
                    return false;
                }
                return true;
            });
            
            const hall1Reservations = individualReservations.filter(r => 
                Array.isArray(r.halls) && r.halls.includes('القاعة رقم 1')
            );
            
            const hall2Reservations = individualReservations.filter(r => 
                Array.isArray(r.halls) && r.halls.includes('القاعة رقم 2')
            );
            
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin: 0; color: var(--primary);">
                        <i class="fas fa-calendar-alt"></i> حفلات العرس في ${formattedDate}
                    </h3>
                </div>
                <div class="brides-grid">
            `;
            
            // عرض حجوزات القاعة 1
            if (hall1Reservations.length > 0) {
                // القاعة 1 - أول حجز
                html += createBrideCard(hall1Reservations[0], 'القاعة 1', 'hall1');
                
                // القاعة 1x - حجز إضافي
                if (hall1Reservations.length > 1) {
                    html += createBrideCard(hall1Reservations[1], 'القاعة 1x', 'hall1x');
                }
            }
            
            // عرض حجوزات القاعة 2
            if (hall2Reservations.length > 0) {
                // القاعة 2 - أول حجز
                html += createBrideCard(hall2Reservations[0], 'القاعة 2', 'hall2');
                
                // القاعة 2x - حجز إضافي
                if (hall2Reservations.length > 1) {
                    html += createBrideCard(hall2Reservations[1], 'القاعة 2x', 'hall2x');
                }
            }
            
            // عرض حجوزات القاعتين معاً
            if (bothHallsReservations.length > 0) {
                bothHallsReservations.forEach((reservation, index) => {
                    html += createBrideCard(reservation, 'القاعتين معاً', 'both-halls');
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ==================== التعديل: إضافة البيانات المالية لكل حجز في صفحة عرسان اليوم ====================
        function createBrideCard(reservation, hallTitle, hallClass) {
            const groomName = reservation.groomName || 'غير محدد';
            const brideName = reservation.brideName || 'غير محدد';
            const groomAddress = reservation.groomAddress || 'غير محدد';
            const brideAddress = reservation.brideAddress || 'غير محدد';
            const eventTime = reservation.eventTime || 'غير محدد';
            
            // إضافة البيانات المالية
            const totalAmount = reservation.totalAmount || 0;
            const paidAmount = reservation.paidAmount || 0;
            const remainingAmount = reservation.remainingAmount || 0;
            
            // تنسيق المبالغ
            const formattedTotal = formatCurrency(totalAmount);
            const formattedPaid = formatCurrency(paidAmount);
            const formattedRemaining = formatCurrency(remainingAmount);
            
            // تحديد لون المبلغ المتبقي
            let remainingColor = '#28a745'; // أخضر إذا تم الدفع بالكامل
            if (remainingAmount > 0) {
                remainingColor = '#dc3545'; // أحمر إذا بقي دفعات
            }
            
            return `
                <div class="bride-card ${hallClass}">
                    <div class="hall-title">${hallTitle}</div>
                    <div class="bride-details-simple">
                        <div class="bride-row">
                            <span class="bride-label">العريس:</span>
                            <span class="bride-value">${groomName}</span>
                        </div>
                        <div class="bride-row">
                            <span class="bride-label">العروس:</span>
                            <span class="bride-value">${brideName}</span>
                        </div>
                        <div class="bride-row">
                            <span class="bride-label">عنوان العريس:</span>
                            <span class="bride-value">${groomAddress}</span>
                        </div>
                        <div class="bride-row">
                            <span class="bride-label">عنوان العروس:</span>
                            <span class="bride-value">${brideAddress}</span>
                        </div>
                        <div class="bride-row">
                            <span class="bride-label">الوقت:</span>
                            <span class="bride-value">${eventTime}</span>
                        </div>
                        
                        <!-- إضافة البيانات المالية -->
                        <div class="bride-row">
                            <span class="bride-label">المبلغ الكلي:</span>
                            <span class="bride-value" style="color: #2c5f2d; font-weight: bold;">${formattedTotal} د.ع</span>
                        </div>
                        <div class="bride-row">
                            <span class="bride-label">المبلغ المدفوع:</span>
                            <span class="bride-value" style="color: #007bff;">${formattedPaid} د.ع</span>
                        </div>
                        <div class="bride-row">
                            <span class="bride-label">المبلغ المتبقي:</span>
                            <span class="bride-value" style="color: ${remainingColor}; font-weight: bold;">${formattedRemaining} د.ع</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // إعداد مستمعي الأحداث لصفحة عرسان اليوم
        document.getElementById('todayBtnSpecial')?.addEventListener('click', function() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('specificDate').value = todayStr;
            showReservationsForDate(todayStr);
        });
        
        document.getElementById('showDateReservations')?.addEventListener('click', function() {
            const dateInput = document.getElementById('specificDate');
            if (dateInput.value) {
                showReservationsForDate(dateInput.value);
            } else {
                showAlert('يرجى اختيار تاريخ', 'error');
            }
        });
        
        // ==================== تحديث قائمة الحجوزات (معدلة للترتيب تنازلياً حسب تاريخ الحفل) ====================
        function updateReservationsTable() {
            const tableBody = document.getElementById('reservationsTableBody');
            tableBody.innerHTML = '';
            
            if (reservations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 30px;">لا توجد حجوزات مسجلة بعد</td></tr>';
                return;
            }
            
            // ========== التعديل: ترتيب تنازلي حسب تاريخ الحفل ==========
            const sortedReservations = [...reservations].sort((a, b) => {
                // التحقق من وجود التواريخ
                const dateA = a.eventDate ? new Date(a.eventDate) : new Date(0);
                const dateB = b.eventDate ? new Date(b.eventDate) : new Date(0);
                
                // الترتيب التنازلي (من الأحدث إلى الأقدم)
                return dateB - dateA;
            });
            
            sortedReservations.forEach(reservation => {
                const row = document.createElement('tr');
                
                let hallBadge = '';
                if (Array.isArray(reservation.halls) && reservation.halls.length === 2) {
                    hallBadge = '<span class="hall-badge-list">1/2</span>';
                } else if (Array.isArray(reservation.halls) && reservation.halls.includes('القاعة رقم 1')) {
                    hallBadge = '<span class="hall-badge-list" style="background-color: #4a8c4a;">1</span>';
                } else {
                    hallBadge = '<span class="hall-badge-list" style="background-color: #d4af37; color: #333;">2</span>';
                }
                
                let photographyBadge = '';
                let photographyText = reservation.photographyServices || 'بدون تصوير';
                if (reservation.photographyServices === 'إضافة تصوير') {
                    photographyBadge = '<span class="photography-badge-list"><i class="fas fa-camera"></i></span>';
                    photographyText = 'إضافة تصوير';
                }
                
                let telegramStatus = '';
                if (reservation.telegramSent) {
                    const sentTime = reservation.telegramSentAt ? 
                        new Date(reservation.telegramSentAt).toLocaleTimeString('ar-IQ', {hour: '2-digit', minute:'2-digit'}) : '';
                    telegramStatus = `<span class="telegram-status telegram-sent"><i class="fab fa-telegram"></i> تم الإرسال ${sentTime ? 'في ' + sentTime : ''}</span>`;
                } else {
                    telegramStatus = '<span class="telegram-status telegram-failed"><i class="fas fa-times-circle"></i> لم يرسل</span>';
                }
                
                // زر إضافة التصوير
                const showAddPhotographyBtn = reservation.photographyServices !== 'إضافة تصوير';
                const addPhotographyBtn = showAddPhotographyBtn ? 
                    `<button class="action-btn camera" onclick="addPhotographyService('${reservation.id}')">
                        <i class="fas fa-camera"></i> تصوير
                    </button>` : '';
                
                const actions = `
                    <div class="action-cell">
                        <button class="action-btn view" onclick="viewReservation('${reservation.id}')">
                            <i class="fas fa-eye"></i> معاينة
                        </button>
                        ${addPhotographyBtn}
                        <button class="action-btn delete" onclick="deleteReservation('${reservation.id}')">
                            <i class="fas fa-trash-alt"></i> حذف
                        </button>
                    </div>
                `;
                
                row.innerHTML = `
                    <td>${reservation.reservationNumber || reservation.id}</td>
                    <td>${reservation.customerName}</td>
                    <td>${reservation.groomName || '-'}</td>
                    <td>${reservation.brideName || '-'}</td>
                    <td>${reservation.groomAddress || '-'}</td>
                    <td>${reservation.brideAddress || '-'}</td>
                    <td>${photographyText} ${photographyBadge}</td>
                    <td>${reservation.phone}</td>
                    <td>${formatDate(reservation.eventDate)}</td>
                    <td>${reservation.eventType}</td>
                    <td>${Array.isArray(reservation.halls) ? reservation.halls.join(', ') : reservation.halls} ${hallBadge}</td>
                    <td>${formatCurrency(reservation.totalAmount)} د.ع</td>
                    <td>${telegramStatus}</td>
                    <td>${actions}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // ==================== إضافة خدمة التصوير لحجز موجود ====================
        window.addPhotographyService = async function(docId) {
            const reservation = reservations.find(r => r.id === docId);
            if (!reservation) return;
            
            if (!confirm(`هل تريد إضافة خدمة التصوير للحجز رقم ${reservation.reservationNumber}؟\nسيتم زيادة المبلغ الكلي بـ 100,000 دينار.`)) {
                return;
            }
            
            showAlert('جاري إضافة خدمة التصوير...', 'info');
            
            try {
                // تحديث البيانات في Firestore
                const updatedData = {
                    photographyServices: 'إضافة تصوير',
                    totalAmount: (parseFloat(reservation.totalAmount) || 0) + PHOTOGRAPHY_ADDITIONAL_PRICE,
                    remainingAmount: ((parseFloat(reservation.totalAmount) || 0) + PHOTOGRAPHY_ADDITIONAL_PRICE) - (parseFloat(reservation.paidAmount) || 0),
                    updatedAt: new Date().toISOString()
                };
                
                await window.firebaseModules.updateDoc(
                    window.firebaseModules.doc(window.firestore, 'reservations', docId),
                    updatedData
                );
                
                // إرسال إشعار تليجرام
                const telegramMessage = `
📸 *إضافة خدمة التصوير - قاعة النخيل للمناسبات* 📸

🔢 *رقم الحجز:* ${reservation.reservationNumber}
👤 *اسم السيد:* ${reservation.customerName}
📅 *تاريخ الحفل:* ${formatDate(reservation.eventDate)}

💰 *التغييرات المالية:*
• المبلغ السابق: ${formatCurrency(reservation.totalAmount)} د.ع
• المبلغ الجديد: ${formatCurrency(parseFloat(reservation.totalAmount) + PHOTOGRAPHY_ADDITIONAL_PRICE)} د.ع
• زيادة بمقدار: ${formatCurrency(PHOTOGRAPHY_ADDITIONAL_PRICE)} د.ع

✅ *تمت إضافة:* خدمة التصوير الكاملة

🕒 *تم التحديث في:* ${new Date().toLocaleTimeString('ar-IQ')}
📅 *تاريخ التحديث:* ${new Date().toLocaleDateString('ar-IQ')}
                `;
                
                sendToAllAdmins(telegramMessage);
                
                // تحديث النسخة الاحتياطية
                const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
                const reservationIndex = backupReservations.findIndex(r => r.id === docId);
                if (reservationIndex !== -1) {
                    backupReservations[reservationIndex] = {
                        ...backupReservations[reservationIndex],
                        ...updatedData
                    };
                    localStorage.setItem('nakhilReservations_backup', JSON.stringify(backupReservations));
                }
                
                // تحديث واجهة المستخدم
                showAlert(`تم إضافة خدمة التصوير للحجز رقم ${reservation.reservationNumber} بنجاح! زيادة 100,000 دينار`, 'success');
                setTimeout(() => {
                    updateReservationsTable();
                }, 1000);
                
            } catch (error) {
                console.error('❌ خطأ في إضافة خدمة التصوير:', error);
                showAlert('خطأ في إضافة خدمة التصوير', 'error');
            }
        };
        
        // ==================== عرض تفاصيل الحجز ====================
        window.viewReservation = function(docId) {
            const reservation = reservations.find(r => r.id === docId);
            if (!reservation) return;
            
            // تعبئة الحقول الرئيسية
            document.getElementById('customerName').value = reservation.customerName;
            document.getElementById('phone').value = reservation.phone;
            document.getElementById('groomName').value = reservation.groomName;
            document.getElementById('brideName').value = reservation.brideName;
            document.getElementById('groomAddress').value = reservation.groomAddress;
            document.getElementById('brideAddress').value = reservation.brideAddress;
            document.getElementById('eventDate').value = reservation.eventDate;
            document.getElementById('eventType').value = reservation.eventType;
            document.getElementById('eventTime').value = reservation.eventTime;
            document.getElementById('totalAmount').value = reservation.totalAmount;
            document.getElementById('paidAmount').value = reservation.paidAmount;
            document.getElementById('remainingAmount').value = reservation.remainingAmount;
            document.getElementById('notes').value = reservation.notes;
            
            // تعيين خدمة التصوير
            const photographyAdd = document.getElementById('photographyAdd');
            const photographyNone = document.getElementById('photographyNone');
            
            if (reservation.photographyServices === 'إضافة تصوير') {
                photographyAdd.checked = true;
            } else {
                photographyNone.checked = true;
            }
            
            // تعيين القاعات
            document.querySelectorAll('input[name="hall"]').forEach(cb => {
                const halls = Array.isArray(reservation.halls) ? reservation.halls : [reservation.halls];
                cb.checked = halls.includes(cb.value);
            });
            
            updateRemainingAmount();
            currentReservationData = reservation;
            
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-page="preview-page"]').classList.add('active');
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('preview-page').classList.add('active');
            
            updatePreview();
            updatePrintContent();
            
            showAlert(`تم تحميل بيانات الحجز رقم ${reservation.reservationNumber || docId}`, 'info');
        };
        
        // ==================== حذف الحجز ====================
        window.deleteReservation = async function(docId) {
            const reservation = reservations.find(r => r.id === docId);
            if (!reservation) return;
            
            if (!confirm(`هل أنت متأكد من حذف الحجز رقم ${reservation.reservationNumber}؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                return;
            }
            
            // حذف من Firebase
            showAlert('جاري حذف الحجز من السحابة...', 'info');
            
            try {
                await window.firebaseModules.deleteDoc(
                    window.firebaseModules.doc(window.firestore, 'reservations', docId)
                );
                
                // تحديث النسخة الاحتياطية
                const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
                const updatedBackup = backupReservations.filter(r => r.id !== docId);
                localStorage.setItem('nakhilReservations_backup', JSON.stringify(updatedBackup));
                
                // إرسال إشعار حذف للتليجرام
                sendDeleteNotificationToTelegram(reservation);
                
                // تحديث واجهة المستخدم
                updateReservationsTable();
                generateCalendar();
                
                showAlert(`تم حذف الحجز رقم ${reservation.reservationNumber} بنجاح`, 'success');
                
            } catch (error) {
                console.error('❌ خطأ في حذف الحجز:', error);
                showAlert('خطأ في حذف الحجز من السحابة', 'error');
            }
        };
        
        // ==================== حذف جميع الحجوزات ====================
        document.getElementById('deleteAllBtn')?.addEventListener('click', async function() {
            if (reservations.length === 0) {
                showAlert('لا توجد حجوزات لحذفها', 'info');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من حذف جميع الحجوزات (${reservations.length} حجز)؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                return;
            }
            
            showAlert('جاري حذف جميع الحجوزات من السحابة...', 'info');
            
            let deletedCount = 0;
            let errorCount = 0;
            
            // حذف كل وثيقة على حدة
            for (const reservation of reservations) {
                try {
                    await window.firebaseModules.deleteDoc(
                        window.firebaseModules.doc(window.firestore, 'reservations', reservation.id)
                    );
                    deletedCount++;
                } catch (error) {
                    console.error(`❌ خطأ في حذف الحجز ${reservation.id}:`, error);
                    errorCount++;
                }
            }
            
            // إرسال إشعار حذف الكل للتليجرام
            sendDeleteAllNotificationToTelegram(reservations.length);
            
            // تحديث البيانات المحلية
            reservations = [];
            reservationCounter = 0;
            localStorage.removeItem('nakhilReservations_backup');
            
            // تحديث واجهة المستخدم
            updateReservationsTable();
            generateCalendar();
            
            if (errorCount > 0) {
                showAlert(`تم حذف ${deletedCount} حجز بنجاح، وفشل حذف ${errorCount} حجز`, 'warning');
            } else {
                showAlert(`تم حذف جميع الحجوزات بنجاح (${deletedCount} حجز)`, 'success');
            }
        });
        
        // ==================== البحث في الحجوزات ====================
        document.getElementById('searchBtn')?.addEventListener('click', searchReservations);
        document.getElementById('searchInput')?.addEventListener('input', searchReservations);
        
        function searchReservations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tableBody = document.getElementById('reservationsTableBody');
            tableBody.innerHTML = '';
            
            const filteredReservations = reservations.filter(reservation => 
                reservation.customerName?.toLowerCase().includes(searchTerm) ||
                reservation.phone?.includes(searchTerm) ||
                reservation.eventType?.toLowerCase().includes(searchTerm) ||
                reservation.groomName?.toLowerCase().includes(searchTerm) ||
                reservation.brideName?.toLowerCase().includes(searchTerm) ||
                reservation.groomAddress?.toLowerCase().includes(searchTerm) ||
                reservation.brideAddress?.toLowerCase().includes(searchTerm) ||
                reservation.reservationNumber?.toString().includes(searchTerm) ||
                reservation.photographyServices?.toLowerCase().includes(searchTerm)
            );
            
            if (filteredReservations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 30px;">لا توجد نتائج تطابق البحث</td></tr>';
                return;
            }
            
            filteredReservations.forEach(reservation => {
                const row = document.createElement('tr');
                
                let hallBadge = '';
                if (Array.isArray(reservation.halls) && reservation.halls.length === 2) {
                    hallBadge = '<span class="hall-badge-list">1/2</span>';
                } else if (Array.isArray(reservation.halls) && reservation.halls.includes('القاعة رقم 1')) {
                    hallBadge = '<span class="hall-badge-list" style="background-color: #4a8c4a;">1</span>';
                } else {
                    hallBadge = '<span class="hall-badge-list" style="background-color: #d4af37; color: #333;">2</span>';
                }
                
                let photographyBadge = '';
                let photographyText = reservation.photographyServices || 'بدون تصوير';
                if (reservation.photographyServices === 'إضافة تصوير') {
                    photographyBadge = '<span class="photography-badge-list"><i class="fas fa-camera"></i></span>';
                    photographyText = 'إضافة تصوير';
                }
                
                let telegramStatus = '';
                if (reservation.telegramSent) {
                    const sentTime = reservation.telegramSentAt ? 
                        new Date(reservation.telegramSentAt).toLocaleTimeString('ar-IQ', {hour: '2-digit', minute:'2-digit'}) : '';
                    telegramStatus = `<span class="telegram-status telegram-sent"><i class="fab fa-telegram"></i> تم الإرسال ${sentTime ? 'في ' + sentTime : ''}</span>`;
                } else {
                    telegramStatus = '<span class="telegram-status telegram-failed"><i class="fas fa-times-circle"></i> لم يرسل</span>';
                }
                
                // زر إضافة التصوير للنتائج المبوبة أيضاً
                const showAddPhotographyBtn = reservation.photographyServices !== 'إضافة تصوير';
                const addPhotographyBtn = showAddPhotographyBtn ? 
                    `<button class="action-btn camera" onclick="addPhotographyService('${reservation.id}')">
                        <i class="fas fa-camera"></i> تصوير
                    </button>` : '';
                
                const actions = `
                    <div class="action-cell">
                        <button class="action-btn view" onclick="viewReservation('${reservation.id}')">
                            <i class="fas fa-eye"></i> معاينة
                        </button>
                        ${addPhotographyBtn}
                        <button class="action-btn delete" onclick="deleteReservation('${reservation.id}')">
                            <i class="fas fa-trash-alt"></i> حذف
                        </button>
                    </div>
                `;
                
                row.innerHTML = `
                    <td>${reservation.reservationNumber || reservation.id}</td>
                    <td>${reservation.customerName}</td>
                    <td>${reservation.groomName || '-'}</td>
                    <td>${reservation.brideName || '-'}</td>
                    <td>${reservation.groomAddress || '-'}</td>
                    <td>${reservation.brideAddress || '-'}</td>
                    <td>${photographyText} ${photographyBadge}</td>
                    <td>${reservation.phone}</td>
                    <td>${formatDate(reservation.eventDate)}</td>
                    <td>${reservation.eventType}</td>
                    <td>${Array.isArray(reservation.halls) ? reservation.halls.join(', ') : reservation.halls} ${hallBadge}</td>
                    <td>${formatCurrency(reservation.totalAmount)} د.ع</td>
                    <td>${telegramStatus}</td>
                    <td>${actions}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // ==================== مسح البحث ====================
        document.getElementById('clearSearch')?.addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            updateReservationsTable();
        });
        
        // ==================== تصدير البيانات ====================
        document.getElementById('exportReservations')?.addEventListener('click', function() {
            if (reservations.length === 0) {
                showAlert('لا توجد بيانات للتصدير', 'error');
                return;
            }
            
            const csvContent = convertToCSV(reservations);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `حجوزات_قاعة_النخيل_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('تم تصدير بيانات الحجوزات بنجاح', 'success');
        });
        
        // ==================== دعم تليجرام ====================
        async function sendToAllAdmins(message) {
            showAlert('جاري إرسال الإشعار للتليجرام...', 'info');
            
            let successCount = 0;
            let failedCount = 0;
            
            for (const chatId of ADMIN_CHAT_IDS) {
                try {
                    const response = await sendTelegramMessage(chatId, message);
                    if (response.ok) {
                        successCount++;
                    } else {
                        failedCount++;
                    }
                } catch (error) {
                    failedCount++;
                }
            }
            
            if (successCount > 0) {
                showAlert(`تم إرسال الإشعار لـ ${successCount} من الأدمنين بنجاح ✅`, 'success');
            }
            
            if (failedCount > 0) {
                showAlert(`فشل إرسال الإشعار لـ ${failedCount} من الأدمنين ❌`, 'error');
            }
        }
        
        async function sendTelegramMessage(chatId, message) {
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            
            return response.json();
        }
        
        function formatTelegramMessage() {
            const data = currentReservationData || getFormData();
            
            const customerName = data.customerName;
            const phone = data.phone;
            const photographyServices = data.photographyServices;
            const eventType = data.eventType;
            const eventDate = formatDate(data.eventDate);
            const eventTime = data.eventTime;
            
            const selectedHalls = Array.isArray(data.halls) ? data.halls : [data.halls];
            const hallText = selectedHalls.length === 2 ? 'القاعتين معاً' : selectedHalls.join(', ');
            
            const totalAmount = data.totalAmount || '0';
            const paidAmount = data.paidAmount || '0';
            const remainingAmount = data.remainingAmount || '0';
            
            const notes = data.notes || 'لا توجد ملاحظات';
            
            return `
🎉 *حجز جديد - قاعة النخيل للمناسبات* 🎉

🔢 *رقم الحجز:* ${reservationCounter + 1}
📅 *تاريخ الحجز:* ${new Date().toLocaleDateString('ar-IQ')}

👤 *معلومات السيد:*
• الاسم: ${customerName}
• الهاتف: ${phone}

💒 *تفاصيل المناسبة:*
• النوع: ${eventType}
• التاريخ: ${eventDate}
• الوقت: ${eventTime}

📸 *خدمة التصوير:*
• ${photographyServices}

🏛️ *القاعة المختارة:*
• ${hallText}

💰 *التفاصيل المالية:*
• المبلغ الكلي: ${formatCurrency(totalAmount)} د.ع
• المبلغ الواصل: ${formatCurrency(paidAmount)} د.ع
• المبلغ المتبقي: ${formatCurrency(remainingAmount)} د.ع

📝 *ملاحظات:*
${notes}

🕒 *تم الحفظ في:* ${new Date().toLocaleTimeString('ar-IQ')}

✅ *حالة الحجز:* مؤكد
            `;
        }
        
        async function sendDeleteNotificationToTelegram(reservation) {
            const message = `
⚠️ *حذف حجز - قاعة النخيل للمناسبات* ⚠️

🔢 *رقم الحجز المحذوف:* ${reservation.reservationNumber}
👤 *اسم السيد:* ${reservation.customerName}
📅 *تاريخ الحفل:* ${formatDate(reservation.eventDate)}
💒 *نوع المناسبة:* ${reservation.eventType}

🕒 *تم الحذف في:* ${new Date().toLocaleTimeString('ar-IQ')}
📅 *تاريخ الحذف:* ${new Date().toLocaleDateString('ar-IQ')}
            `;
            
            try {
                await sendToAllAdmins(message);
            } catch (error) {
                console.error('خطأ في إرسال إشعار الحذف:', error);
            }
        }
        
        async function sendDeleteAllNotificationToTelegram(count) {
            const message = `
🚨 *حذف جميع الحجوزات - قاعة النخيل للمناسبات* 🚨

🔢 *عدد الحجوزات المحذوفة:* ${count}

🕒 *تم الحذف في:* ${new Date().toLocaleTimeString('ar-IQ')}
📅 *تاريخ الحذف:* ${new Date().toLocaleDateString('ar-IQ')}
            `;
            
            try {
                await sendToAllAdmins(message);
            } catch (error) {
                console.error('خطأ في إرسال إشعار حذف الكل:', error);
            }
        }
        
        async function testTelegramConnection() {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe`);
                const data = await response.json();
                
                if (data.ok) {
                    console.log('✅ اتصال تليجرام نشط:', data.result.username);
                }
            } catch (error) {
                console.error('❌ خطأ في اتصال تليجرام:', error);
            }
        }
        
        // ==================== دوال مساعدة ====================
        function convertToCSV(data) {
            const headers = ['رقم الحجز', 'اسم السيد', 'رقم الهاتف', 'اسم العريس', 'اسم العروس', 'عنوان العريس', 'عنوان العروس', 'خدمة التصوير', 'تاريخ الحفل', 'نوع المناسبة', 'الوقت', 'القاعة', 'المبلغ الكلي', 'المبلغ الواصل', 'المبلغ المتبقي', 'تاريخ الحجز', 'حالة التليجرام', 'وقت الإرسال', 'الحالة'];
            const rows = data.map(item => [
                item.reservationNumber || item.id,
                item.customerName,
                item.phone,
                item.groomName || '',
                item.brideName || '',
                item.groomAddress || '',
                item.brideAddress || '',
                item.photographyServices || 'بدون تصوير',
                item.eventDate,
                item.eventType,
                item.eventTime,
                Array.isArray(item.halls) ? item.halls.join(' + ') : item.halls,
                item.totalAmount,
                item.paidAmount,
                item.remainingAmount,
                item.bookingDate,
                item.telegramSent ? 'تم الإرسال' : 'لم يرسل',
                item.telegramSentAt || '',
                item.status
            ]);
            
            return [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-IQ');
        }
        
        function formatCurrency(amount) {
            return parseFloat(amount).toLocaleString('ar-IQ');
        }
        
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        // ==================== نظام المزامنة الذكية مع Firebase ====================
let pendingReservations = JSON.parse(localStorage.getItem('pendingReservations')) || [];

// حفظ حجز محلياً عند عدم وجود نت
function saveReservationLocally(reservationData) {
    const localId = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const localReservation = {
        id: localId,
        ...reservationData,
        createdAt: new Date().toISOString(),
        synced: false
    };
    
    pendingReservations.push(localReservation);
    localStorage.setItem('pendingReservations', JSON.stringify(pendingReservations));
    
    // تخزين في localStorage كنسخة احتياطية رئيسية
    const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
    backupReservations.push(localReservation);
    localStorage.setItem('nakhilReservations_backup', JSON.stringify(backupReservations));
    
    return localReservation;
}

// محاولة مزامنة الحجوزات المعلقة
async function syncPendingReservations() {
    if (pendingReservations.length === 0 || !navigator.onLine) return;
    
    showAlert('جاري مزامنة البيانات مع السحابة...', 'info');
    
    const syncedReservations = [];
    const failedReservations = [];
    
    for (const localReservation of pendingReservations) {
        try {
            // تحضير بيانات الحجز للإرسال
            const firestoreData = {
                ...localReservation,
                synced: true,
                syncedAt: new Date().toISOString()
            };
            delete firestoreData.id; // نحذف الـ id المحلي
        
            // إرسال إلى Firebase
            const docRef = await window.firebaseModules.addDoc(
                window.firebaseModules.collection(window.firestore, 'reservations'),
                firestoreData
            );
            
            // تحديث النسخة الاحتياطية
            const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
            const updatedBackup = backupReservations.map(r => 
                r.id === localReservation.id ? {...r, synced: true, firebaseId: docRef.id} : r
            );
            localStorage.setItem('nakhilReservations_backup', JSON.stringify(updatedBackup));
            
            syncedReservations.push(localReservation.id);
            console.log('✅ تمت مزامنة حجز:', localReservation.id);
            
        } catch (error) {
            console.error('❌ فشلت مزامنة حجز:', localReservation.id, error);
            failedReservations.push(localReservation);
        }
    }
    
    // تحديث قائمة الحجوزات المعلقة
    pendingReservations = pendingReservations.filter(r => !syncedReservations.includes(r.id));
    localStorage.setItem('pendingReservations', JSON.stringify(pendingReservations));
    
    // إعادة تحميل الحجوزات من Firebase
    if (syncedReservations.length > 0) {
        await loadReservationsFromFirestore();
    }
    
    if (syncedReservations.length > 0) {
        showAlert(`✅ تمت مزامنة ${syncedReservations.length} حجز بنجاح`, 'success');
    }
    
    if (failedReservations.length > 0) {
        showAlert(`⚠️ فشلت مزامنة ${failedReservations.length} حجز - سيتم المحاولة لاحقاً`, 'warning');
    }
}

// تعديل دالة saveReservationToFirestore لتعمل بدون إنترنت
async function saveReservationToFirestore(reservationData) {
    // التحقق من وجود اتصال
    if (!navigator.onLine) {
        // حفظ محلياً
        const localReservation = saveReservationLocally(reservationData);
        reservationCounter = Math.max(reservationCounter, parseInt(localReservation.reservationNumber) || 0);
        
        // إضافة إلى قائمة الحجوزات المحلية
        const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
        reservations = backupReservations;
        
        showAlert('⚠️ أنت غير متصل بالإنترنت. تم حفظ الحجز محلياً وسيتم مزامنته تلقائياً عند عودة الاتصال', 'warning');
        
        return {
            success: true,
            docId: localReservation.id,
            reservationNumber: localReservation.reservationNumber,
            data: localReservation,
            offline: true
        };
    }
    
    // إذا كان هناك اتصال، نحفظ في Firebase كالمعتاد
    try {
        reservationCounter++;
        const firestoreData = {
            ...reservationData,
            reservationNumber: reservationCounter,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        const docRef = await window.firebaseModules.addDoc(
            window.firebaseModules.collection(window.firestore, 'reservations'),
            firestoreData
        );
        
        // حفظ نسخة احتياطية محلية
        const backupReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
        backupReservations.push({
            id: docRef.id,
            ...firestoreData,
            synced: true
        });
        localStorage.setItem('nakhilReservations_backup', JSON.stringify(backupReservations));
        
        return {
            success: true,
            docId: docRef.id,
            reservationNumber: reservationCounter,
            data: firestoreData
        };
        
    } catch (error) {
        console.error('❌ خطأ في الحفظ:', error);
        // إذا فشل الاتصال رغم وجود نت، نحفظ محلياً
        return saveReservationToFirestore(reservationData);
    }
}

// مراقبة حالة الاتصال والمزامنة التلقائية
window.addEventListener('online', function() {
    console.log('✅ عودة الاتصال بالإنترنت - بدء المزامنة');
    showAlert('تمت استعادة الاتصال، جاري مزامنة البيانات...', 'info');
    syncPendingReservations();
});

// محاولة المزامنة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    if (navigator.onLine && pendingReservations.length > 0) {
        syncPendingReservations();
    }
});

// تعديل دالة loadReservationsFromFirestore لدمج البيانات المحلية
async function loadReservationsFromFirestore() {
    try {
        if (!navigator.onLine) {
            // إذا كنا أوفلاين، نعرض البيانات المحلية فقط
            const localData = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
            reservations = localData.sort((a, b) => {
                const dateA = a.eventDate ? new Date(a.eventDate) : new Date(0);
                const dateB = b.eventDate ? new Date(b.eventDate) : new Date(0);
                return dateB - dateA;
            });
            
            reservationCounter = Math.max(...reservations.map(r => parseInt(r.reservationNumber) || 0), 0);
            updateReservationsTable();
            generateCalendar();
            showAlert('أنت غير متصل - تعرض البيانات المحلية المحفوظة', 'info');
            return;
        }
        
        // إذا كنا أونلاين، نجلب من Firebase
        showAlert('جاري تحميل الحجوزات من السحابة...', 'info');
        
        const reservationsCollection = window.firebaseModules.collection(window.firestore, 'reservations');
        const q = window.firebaseModules.query(reservationsCollection, window.firebaseModules.orderBy('eventDate', 'desc'));
        const querySnapshot = await window.firebaseModules.getDocs(q);
        
        const firebaseReservations = [];
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            firebaseReservations.push({
                id: doc.id,
                ...data,
                synced: true
            });
        });
        
        // دمج مع البيانات المحلية غير المتزامنة
        const localReservations = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
        const unsyncedLocal = localReservations.filter(r => !r.synced);
        
        reservations = [...firebaseReservations, ...unsyncedLocal].sort((a, b) => {
            const dateA = a.eventDate ? new Date(a.eventDate) : new Date(0);
            const dateB = b.eventDate ? new Date(b.eventDate) : new Date(0);
            return dateB - dateA;
        });
        
        // حفظ النسخة المدمجة محلياً
        localStorage.setItem('nakhilReservations_backup', JSON.stringify(reservations));
        
        // حساب أعلى رقم حجز
        reservationCounter = Math.max(...reservations.map(r => parseInt(r.reservationNumber) || 0), 0);
        
        updateReservationsTable();
        generateCalendar();
        
        if (unsyncedLocal.length > 0) {
            showAlert(`تم تحميل ${firebaseReservations.length} حجز من السحابة + ${unsyncedLocal.length} حجز محلي غير متزامن`, 'info');
            // محاولة مزامنة المحلية
            syncPendingReservations();
        } else {
            showAlert(`تم تحميل ${reservations.length} حجز من السحابة`, 'success');
        }
        
        setupRealtimeListener();
        
    } catch (error) {
        console.error('❌ خطأ في تحميل الحجوزات:', error);
        
        // في حالة الخطأ، نعرض البيانات المحلية
        const localData = JSON.parse(localStorage.getItem('nakhilReservations_backup')) || [];
        reservations = localData;
        if (reservations.length > 0) {
            reservationCounter = Math.max(...reservations.map(r => parseInt(r.reservationNumber) || 0));
            updateReservationsTable();
            generateCalendar();
            showAlert('خطأ في الاتصال بالسحابة - تعرض النسخة المحلية', 'error');
        }
    }
}
    </script>
</body>

</html>
